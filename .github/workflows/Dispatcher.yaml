name: Data Freshness Dispatcher

on:
  schedule:
    # Run every 6 hours at offset times to avoid conflicts with Actions.yaml
    # Actions.yaml schedule (with ~1.5h task duration):
    #   02:00-03:30 T18 | 06:00-07:30 Weekly | 10:00-11:30 T1
    #   14:00-15:30 Evening | 18:00-19:30 T5 | 22:00-23:30 T13
    # Dispatcher uses safe gaps: 04:00, 09:00, 16:00, 20:00 UTC
    - cron: '0 4,9,16,20 * * *'
  workflow_dispatch:      # Allow manual trigger

jobs:
  check-and-dispatch:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Check for Oldest Data
        id: check
        run: |
          # Run the script and capture the ID of the oldest data type
          # Returns nothing if all data is fresh (< 5 days old)
          DATA_TYPE=$(python check_oldest.py)
          echo "Oldest Data Type ID: $DATA_TYPE"
          echo "data_type=$DATA_TYPE" >> $GITHUB_OUTPUT

      - name: Trigger Main Downloader
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TYPE_ID=${{ steps.check.outputs.data_type }}
          
          if [ -z "$TYPE_ID" ]; then
            echo "✅ All data is fresh (updated within last 5 days). No action needed."
            exit 0
          fi
          
          echo "⚠️ Found stale data type: $TYPE_ID. Triggering update..."
          
          # Trigger the main Actions.yaml workflow
          gh workflow run Actions.yaml -f data_type="$TYPE_ID"