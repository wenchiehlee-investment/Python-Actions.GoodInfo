name: Data Freshness Dispatcher

on:
  schedule:
    - cron: '0 */6 * * *'  # Run every 6 hours to check for stale data
  workflow_dispatch:      # Allow manual trigger

jobs:
  check-and-dispatch:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Check for Oldest Data
        id: check
        run: |
          # Run the script and capture the ID of the oldest data type
          # Returns nothing if all data is fresh (< 7 days old)
          DATA_TYPE=$(python check_oldest.py)
          echo "Oldest Data Type ID: $DATA_TYPE"
          echo "data_type=$DATA_TYPE" >> $GITHUB_OUTPUT

      - name: Trigger Main Downloader
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TYPE_ID=${{ steps.check.outputs.data_type }}
          
          if [ -z "$TYPE_ID" ]; then
            echo "✅ All data is fresh (updated within last 7 days). No action needed."
            exit 0
          fi
          
          echo "⚠️ Found stale data type: $TYPE_ID. Triggering update..."
          
          # Trigger the main Actions.yaml workflow
          gh workflow run Actions.yaml -f data_type="$TYPE_ID"