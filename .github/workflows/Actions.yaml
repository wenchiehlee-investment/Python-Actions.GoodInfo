name: GoodInfo Downloader v3.2.0

# Prevent concurrent runs to avoid commit conflicts
# New runs will queue and wait for the previous run to complete
concurrency:
  group: goodinfo-downloader
  cancel-in-progress: false

on:
  # Enhanced Complete Multi-Frequency Automation - Weekly + Daily + Monthly with Type 12-18 (v3.2.0)
  # v3.2.0: Added Type 17 (Weekly K-Line Chart Flow) and Type 18 (Daily K-Line Chart Flow)
  # FIXED v3.1.1: Remove exact MINUTE checks to fix Type 11/12/14/15/16 not triggering due to workflow startup delay
  schedule:
    # ========================================
    # v3.2.0 OPTIMIZED SCHEDULE - 2 hour gaps between tasks
    # Each task takes ~1.5 hours (1h to 1h40m)
    # ========================================

    # ========================================
    # SLOT A: 06:00 UTC (14:00 Taiwan) - Weekly Types
    # ========================================
    - cron: '0 6 * * 2'    # Tuesday - Business Performance (Type 4)
    - cron: '0 6 * * 3'    # Wednesday - Equity Distribution (Type 6)
    - cron: '0 6 * * 4'    # Thursday - Quarterly Performance (Type 7)
    - cron: '0 6 * * 5'    # Friday - EPS x PER Weekly (Type 8)
    - cron: '0 6 * * 6'    # Saturday - Quarterly Analysis (Type 9)
    - cron: '0 6 * * 0'    # Sunday - Equity Class Weekly (Type 10)

    # ========================================
    # SLOT B: 10:00 UTC (18:00 Taiwan) - Daily Type 1
    # Gap from Slot A: 2.5 hours (06:00+1.5h=07:30 ‚Üí 10:00)
    # ========================================
    - cron: '0 10 * * *'   # Daily - Dividend Detail (Type 1) Áï∂Êó•ÂÉπ

    # ========================================
    # SLOT C: 14:00 UTC (22:00 Taiwan) - Weekly/Monthly Evening
    # Gap from Slot B: 2.5 hours (10:00+1.5h=11:30 ‚Üí 14:00)
    # ========================================
    - cron: '0 14 * * 1'   # Monday - Weekly Trading Data (Type 11)
    - cron: '0 14 1-7 * 2' # First Tuesday - EPS x PER Monthly (Type 12)
    - cron: '0 14 1-7 * 3' # First Wednesday - Monthly Margin Balance (Type 15)
    - cron: '10 14 1-7 * 3' # First Wednesday +10min - Quarterly Financial Ratio (Type 16)
    - cron: '0 14 * * 4'   # Thursday - Weekly K-Line Chart Flow (Type 17) üÜï
    - cron: '0 14 * * 5'   # Friday - Weekly Margin Balance (Type 14)

    # ========================================
    # SLOT D: 18:00 UTC (02:00 Taiwan+1) - Daily Type 5
    # Gap from Slot C: 2.5 hours (14:00+1.5h=15:30 ‚Üí 18:00)
    # Only runs on specific days (6-15, 1, 22)
    # ========================================
    - cron: '0 18 6-15 * *'   # Days 6-15 - Monthly Revenue (Type 5) Peak window
    - cron: '0 18 1,22 * *'   # Days 1 & 22 - Monthly Revenue (Type 5) Maintenance

    # ========================================
    # SLOT E: 22:00 UTC (06:00 Taiwan+1) - Daily Type 13
    # Gap from Slot D: 2.5 hours (18:00+1.5h=19:30 ‚Üí 22:00)
    # ========================================
    - cron: '0 22 * * *'   # Daily - Daily Margin Balance (Type 13)

    # ========================================
    # SLOT F: 02:00 UTC (10:00 Taiwan) - Daily Type 18
    # Gap from Slot E: 2.5 hours (22:00+1.5h=23:30 ‚Üí 02:00)
    # ========================================
    - cron: '0 2 * * *'    # Daily - Daily K-Line Chart Flow (Type 18) üÜï

  # Allow manual trigger for all 18 data types (v3.2.0)
  workflow_dispatch:
    inputs:
      data_type:
        description: 'Data type to download (Complete 18 Data Types - v3.2.0)'
        required: false
        default: '1'
        type: choice
        options:
        - '1'   # Dividend Policy (Weekly - Monday)
        - '2'   # Basic Info (Manual only)
        - '3'   # Stock Details (Manual only)
        - '4'   # Business Performance (Weekly - Tuesday)
        - '5'   # Monthly Revenue (Daily)
        - '6'   # Equity Distribution (Weekly - Wednesday)
        - '7'   # Quarterly Performance (Weekly - Thursday)
        - '8'   # EPS x PER Weekly (Weekly - Friday)
        - '9'   # Quarterly Analysis (Weekly - Saturday)
        - '10'  # Equity Class Weekly (Weekly - Sunday)
        - '11'  # Weekly Trading Data (Weekly - Monday Evening)
        - '12'  # EPS x PER Monthly (Monthly - First Tuesday) üÜï
        - '13'  # Daily Margin Balance (Daily - Evening) üÜï
        - '14'  # Weekly Margin Balance (Weekly - Friday Evening) üÜï
        - '15'  # Monthly Margin Balance (Monthly - First Wednesday) üÜï
        - '16'  # Quarterly Financial Ratio Analysis (Monthly - First Wednesday) üÜï
        - '17'  # Weekly K-Line Chart Flow (Weekly - Thursday Evening) üÜï
        - '18'  # Daily K-Line Chart Flow (Daily - Midnight) üÜï
      test_mode:
        description: 'Test mode (only first 3 stocks)'
        required: false
        default: false
        type: boolean

jobs:
  download:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max for complex workflows including Type 12
    outputs:
      data_type: ${{ steps.params.outputs.data_type }}
      data_desc: ${{ steps.params.outputs.data_desc }}
      total_files: ${{ steps.summary.outputs.total_files }}
      duration: ${{ steps.summary.outputs.duration }}
      start_time: ${{ steps.summary.outputs.start_time }}
      end_time: ${{ steps.summary.outputs.end_time }}
      total_stocks: ${{ steps.summary.outputs.total_stocks }}
      success_stocks: ${{ steps.summary.outputs.success_stocks }}
      failed_stocks: ${{ steps.summary.outputs.failed_stocks }}
    steps:
    - name: Record Start Time
      id: start
      run: |
        START_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        START_TIMESTAMP=$(date -u +%s)
        echo "start_time=$START_TIME" >> $GITHUB_OUTPUT
        echo "start_timestamp=$START_TIMESTAMP" >> $GITHUB_OUTPUT
        echo "Workflow started at: $START_TIME"
    
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Setup Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable xvfb
    
    - name: Download Stock List
      run: |
        echo "Downloading latest Taiwan stock observation list..."
        python GetËßÄÂØüÂêçÂñÆ.py
        
        echo "Stock list status:"
        if [ -f "StockID_TWSE_TPEX.csv" ]; then
          echo "Stock list downloaded successfully"
          STOCK_COUNT=$(tail -n +2 StockID_TWSE_TPEX.csv | wc -l)
          echo "Total stocks: $STOCK_COUNT"
          echo "First 5 stocks:"
          head -6 StockID_TWSE_TPEX.csv
          echo "stock_count=$STOCK_COUNT" >> $GITHUB_OUTPUT
        else
          echo "Failed to download stock list"
          exit 1
        fi
    
    - name: Determine Execution Parameters
      id: params
      run: |
        # Enhanced parameter determination for complete 18 data types (v3.2.0)
        if [[ "${{ github.event_name }}" == "schedule" ]]; then
          # For scheduled runs, determine type by day of week, hour, and minute
          HOUR=$(date -u +%H)
          MINUTE=$(date -u +%M)
          DAY_OF_WEEK=$(date -u +%u)  # 1=Monday, 2=Tuesday, 3=Wednesday, 4=Thursday, 5=Friday, 6=Saturday, 7=Sunday
          DAY_OF_MONTH=$(date -u +%d)

          # IMPORTANT: GitHub Actions can have 1-2 hour delays, so accept hour ranges
          if [[ "$HOUR" == "06" || "$HOUR" == "07" ]]; then
            # SLOT A: 6:00 AM UTC (14:00 Taiwan) - Weekly types based on day of week
            # Accepts 06-07 to handle GitHub Actions delays
            case $DAY_OF_WEEK in
              2) DATA_TYPE="4"; TYPE_NAME="Business Performance"; FREQUENCY="Weekly-Tue" ;;
              3) DATA_TYPE="6"; TYPE_NAME="Equity Distribution"; FREQUENCY="Weekly-Wed" ;;
              4) DATA_TYPE="7"; TYPE_NAME="Quarterly Performance"; FREQUENCY="Weekly-Thu" ;;
              5) DATA_TYPE="8"; TYPE_NAME="EPS x PER Weekly"; FREQUENCY="Weekly-Fri" ;;
              6) DATA_TYPE="9"; TYPE_NAME="Quarterly Analysis"; FREQUENCY="Weekly-Sat" ;;
              7) DATA_TYPE="10"; TYPE_NAME="Equity Class Weekly"; FREQUENCY="Weekly-Sun" ;;
              *) DATA_TYPE="4"; TYPE_NAME="Business Performance"; FREQUENCY="Weekly-Default" ;;
            esac
          elif [[ "$HOUR" == "10" || "$HOUR" == "11" ]]; then
            # SLOT B: 10:00 AM UTC (18:00 Taiwan) - Type 1 Daily
            # Accepts 10-11 to handle GitHub Actions delays
            DATA_TYPE="1"
            TYPE_NAME="Dividend Detail"
            FREQUENCY="Daily-AfterMarket"
          elif [[ "$HOUR" == "14" || "$HOUR" == "15" ]]; then
            # SLOT C: 2 PM UTC (22:00 Taiwan) - Weekly/Monthly Evening types
            # Accepts 14-15 to handle GitHub Actions delays
            # Use DAY_OF_WEEK (+ DAY_OF_MONTH for monthly) to determine type
            if [[ "$DAY_OF_WEEK" == "3" && $DAY_OF_MONTH -le 7 ]]; then
              # First Wednesday 2 PM UTC - Type 15 or Type 16 (distinguish by minute range)
              if [[ "$MINUTE" -ge 10 ]]; then
                # Type 16: Cron at 14:10, script runs around 14:10-14:50
                DATA_TYPE="16"
                TYPE_NAME="Quarterly Financial Ratio Analysis"
                FREQUENCY="Monthly-First-Wed-Staggered"
              else
                # Type 15: Cron at 14:00, script runs around 14:00-14:09
                DATA_TYPE="15"
                TYPE_NAME="Monthly Margin Balance"
                FREQUENCY="Monthly-First-Wed"
              fi
            elif [[ "$DAY_OF_WEEK" == "1" ]]; then
              # Monday 2 PM UTC - Type 11 Weekly Trading Data
              DATA_TYPE="11"
              TYPE_NAME="Weekly Trading Data"
              FREQUENCY="Weekly-Mon-Evening"
            elif [[ "$DAY_OF_WEEK" == "2" && $DAY_OF_MONTH -le 7 ]]; then
              # First Tuesday 2 PM UTC - Type 12 EPS x PER Monthly
              DATA_TYPE="12"
              TYPE_NAME="EPS x PER Monthly"
              FREQUENCY="Monthly-First-Tue"
            elif [[ "$DAY_OF_WEEK" == "5" ]]; then
              # Friday 2 PM UTC - Type 14 Weekly Margin Balance
              DATA_TYPE="14"
              TYPE_NAME="Weekly Margin Balance"
              FREQUENCY="Weekly-Fri-Evening"
            elif [[ "$DAY_OF_WEEK" == "4" ]]; then
              # Thursday 2 PM UTC - Type 17 Weekly K-Line Chart Flow üÜï
              DATA_TYPE="17"
              TYPE_NAME="Weekly K-Line Chart Flow"
              FREQUENCY="Weekly-Thu-Evening"
            else
              # Fallback for other cases at 2 PM UTC
              DATA_TYPE="1"
              TYPE_NAME="Dividend Policy"
              FREQUENCY="Fallback"
            fi
          elif [[ "$HOUR" == "18" || "$HOUR" == "19" ]]; then
            # SLOT D: 6 PM UTC (02:00 Taiwan+1) - Type 5 Monthly Revenue
            # Accepts 18-19 to handle GitHub Actions delays
            DATA_TYPE="5"
            TYPE_NAME="Monthly Revenue"
            if [[ $DAY_OF_MONTH -ge 6 && $DAY_OF_MONTH -le 15 ]]; then
              FREQUENCY="Daily-Peak-Window"
            elif [[ $DAY_OF_MONTH -eq 1 || $DAY_OF_MONTH -eq 22 ]]; then
              FREQUENCY="Monthly-Maintenance"
            else
              FREQUENCY="Unscheduled"
            fi
          elif [[ "$HOUR" == "22" || "$HOUR" == "23" ]]; then
            # SLOT E: 10 PM UTC (06:00 Taiwan+1) - Type 13 Daily Margin Balance
            # Accepts 22-23 to handle GitHub Actions delays
            DATA_TYPE="13"
            TYPE_NAME="Daily Margin Balance"
            FREQUENCY="Daily-EarlyMorning"
          elif [[ "$HOUR" == "02" || "$HOUR" == "03" ]]; then
            # SLOT F: 2 AM UTC (10:00 Taiwan) - Type 18 Daily K-Line Chart Flow üÜï
            # Accepts 02-03 to handle GitHub Actions delays
            DATA_TYPE="18"
            TYPE_NAME="Daily K-Line Chart Flow"
            FREQUENCY="Daily-Morning"
          else
            DATA_TYPE="1"
            TYPE_NAME="Dividend Policy"
            FREQUENCY="Fallback"
          fi
          TRIGGER_TYPE="Auto"
        else
          # Manual trigger - use input
          DATA_TYPE="${{ github.event.inputs.data_type || '1' }}"
          TRIGGER_TYPE="Manual"
          FREQUENCY="On-Demand"
          
          # Set type names for manual triggers (Enhanced for complete 18 types - v3.2.0)
          case $DATA_TYPE in
            1) TYPE_NAME="Dividend Policy" ;;
            2) TYPE_NAME="Basic Info" ;;
            3) TYPE_NAME="Stock Details" ;;
            4) TYPE_NAME="Business Performance" ;;
            5) TYPE_NAME="Monthly Revenue" ;;
            6) TYPE_NAME="Equity Distribution" ;;
            7) TYPE_NAME="Quarterly Performance" ;;
            8) TYPE_NAME="EPS x PER Weekly" ;;
            9) TYPE_NAME="Quarterly Analysis" ;;
            10) TYPE_NAME="Equity Class Weekly" ;;
            11) TYPE_NAME="Weekly Trading Data" ;;
            12) TYPE_NAME="EPS x PER Monthly" ;;
            13) TYPE_NAME="Daily Margin Balance" ;;
            14) TYPE_NAME="Weekly Margin Balance" ;;
            15) TYPE_NAME="Monthly Margin Balance" ;;
            16) TYPE_NAME="Quarterly Financial Ratio Analysis" ;;
            17) TYPE_NAME="Weekly K-Line Chart Flow" ;;
            18) TYPE_NAME="Daily K-Line Chart Flow" ;;
          esac
        fi
        
        echo "data_type=$DATA_TYPE" >> $GITHUB_OUTPUT
        echo "data_desc=$TYPE_NAME" >> $GITHUB_OUTPUT
        echo "type_name=$TYPE_NAME" >> $GITHUB_OUTPUT
        echo "frequency=$FREQUENCY" >> $GITHUB_OUTPUT
        echo "trigger_type=$TRIGGER_TYPE" >> $GITHUB_OUTPUT
        
        # Set test mode flag
        if [[ "${{ github.event.inputs.test_mode }}" == "true" ]]; then
          echo "test_flag=--test" >> $GITHUB_OUTPUT
          echo "mode_desc=Test Mode (3 stocks)" >> $GITHUB_OUTPUT
          TEST_MODE="Test"
        else
          echo "test_flag=" >> $GITHUB_OUTPUT
          echo "mode_desc=Full Mode (all stocks)" >> $GITHUB_OUTPUT
          TEST_MODE="Full"
        fi
        
        echo "test_mode=$TEST_MODE" >> $GITHUB_OUTPUT
        
        # Enhanced execution info with Type 12-18 support (v3.2.0)
        echo "Executing: Type $DATA_TYPE ($TYPE_NAME) | $FREQUENCY | $TEST_MODE Mode"
        if [[ "$DATA_TYPE" == "12" ]]; then
          echo "üÜï NEW FEATURE! EPS x PER Monthly - 20-Year Long-Term Valuation Analysis"
        elif [[ "$DATA_TYPE" == "11" ]]; then
          echo "Enhanced Weekly Trading Data with Institutional Flows"
        elif [[ "$DATA_TYPE" == "13" ]]; then
          echo "üÜï NEW FEATURE! Daily Margin Balance - Market Sentiment Analysis"
        elif [[ "$DATA_TYPE" == "14" ]]; then
          echo "üÜï NEW FEATURE! Weekly Margin Balance - 5-Year History"
        elif [[ "$DATA_TYPE" == "15" ]]; then
          echo "üÜï NEW FEATURE! Monthly Margin Balance - 20-Year History"
        elif [[ "$DATA_TYPE" == "17" ]]; then
          echo "üÜï NEW FEATURE! Weekly K-Line Chart Flow - 5-Year Weekly Capital Flow Analysis"
        elif [[ "$DATA_TYPE" == "18" ]]; then
          echo "üÜï NEW FEATURE! Daily K-Line Chart Flow - 1-Year Daily Capital Flow Analysis"
        fi
        
    - name: Execute Data Download - Type ${{ steps.params.outputs.data_type }} (${{ steps.params.outputs.type_name }})
      id: download
      timeout-minutes: 300  # 5 hours for complex workflows including Type 12
      continue-on-error: true  # Don't fail entire workflow if this times out
      run: |
        echo "Starting enhanced download execution..."
        echo "Data Type: ${{ steps.params.outputs.type_name }} (Type ${{ steps.params.outputs.data_type }})"
        echo "Frequency: ${{ steps.params.outputs.frequency }}"
        echo "Mode: ${{ steps.params.outputs.mode_desc }}"
        echo "Trigger: ${{ steps.params.outputs.trigger_type }}"
        echo "Version: v3.2.0 - Complete 18 Data Types (Added Type 17/18 K-Line Chart Flow)"
        echo "Timeout: 300 minutes (5 hours)"
        
        # Enhanced special workflow information including Type 12
        case "${{ steps.params.outputs.data_type }}" in
          5) echo "Special Workflow: Monthly Revenue - Auto-click Êü•20Âπ¥ button" ;;
          6) echo "Equity Distribution - Shareholder structure analysis" ;;
          7) echo "Special Workflow: Quarterly Performance - Special URL + Auto-click Êü•60Âπ¥ button" ;;
          8) echo "Special Workflow: EPS x PER Weekly - Special URL + Auto-click Êü•5Âπ¥ button" ;;
          9) echo "Standard Workflow: Quarterly Analysis - 4-quarter detailed statistical data" ;;
          10) echo "Special Workflow: Equity Class Weekly - Auto-click Êü•5Âπ¥ button" ;;
          11) echo "Enhanced Workflow: Weekly Trading Data - Special URL + Auto-click Êü•5Âπ¥ button" ;;
          12) echo "üÜï NEW! Enhanced Workflow: EPS x PER Monthly - Special URL + Auto-click Êü•20Âπ¥ button" ;;
          13) echo "üÜï NEW! Enhanced Workflow: Daily Margin Balance - Special URL + Auto-click Êü•1Âπ¥ button" ;;
          14) echo "üÜï NEW! Enhanced Workflow: Weekly Margin Balance - Special URL + Auto-click Êü•5Âπ¥ button" ;;
          15) echo "üÜï NEW! Enhanced Workflow: Monthly Margin Balance - Special URL + Auto-click Êü•20Âπ¥ button" ;;
          16) echo "üÜï NEW! Enhanced Workflow: Quarterly Financial Ratio Analysis - Special URL + Wait 5 seconds" ;;
          17) echo "üÜï NEW! Enhanced Workflow: Weekly K-Line Chart Flow - Special URL + Auto-click Êü•5Âπ¥ button" ;;
          18) echo "üÜï NEW! Enhanced Workflow: Daily K-Line Chart Flow - Special URL + Auto-click Êü•1Âπ¥ button" ;;
        esac
        
        # Show Type 12-18 specific features (v3.2.0)
        if [[ "${{ steps.params.outputs.data_type }}" == "12" ]]; then
          echo "üÜï Type 12 Features:"
          echo "   ‚Ä¢ 20-year monthly EPS and P/E ratio data"
          echo "   ‚Ä¢ Conservative P/E multiples (9X-19X)"
          echo "   ‚Ä¢ Long-term valuation trend analysis"
          echo "   ‚Ä¢ Monthly granularity for macro correlation"
          echo "   ‚Ä¢ Backtesting and portfolio management support"
          echo "   ‚Ä¢ Cross-reference with Type 8 weekly data"
        elif [[ "${{ steps.params.outputs.data_type }}" == "13" ]]; then
          echo "üÜï Type 13 Features:"
          echo "   ‚Ä¢ Daily margin balance data (1-year history)"
          echo "   ‚Ä¢ Financing vs Short Selling analysis"
          echo "   ‚Ä¢ Margin usage and maintenance rates"
          echo "   ‚Ä¢ Daily sentiment tracking"
        elif [[ "${{ steps.params.outputs.data_type }}" == "14" ]]; then
          echo "üÜï Type 14 Features:"
          echo "   ‚Ä¢ Weekly margin balance data (5-year history)"
          echo "   ‚Ä¢ Mid-term sentiment trend analysis"
        elif [[ "${{ steps.params.outputs.data_type }}" == "15" ]]; then
          echo "üÜï Type 15 Features:"
          echo "   ‚Ä¢ Monthly margin balance data (20-year history)"
          echo "   ‚Ä¢ Long-term sentiment cycle analysis"
        elif [[ "${{ steps.params.outputs.data_type }}" == "16" ]]; then
          echo "üÜï Type 16 Features:"
          echo "   ‚Ä¢ Quarterly financial ratio analysis (latest 10 quarters)"
          echo "   ‚Ä¢ Profitability, efficiency, leverage ratios"
          echo "   ‚Ä¢ Complements quarterly performance and analysis"
        elif [[ "${{ steps.params.outputs.data_type }}" == "17" ]]; then
          echo "üÜï Type 17 Features:"
          echo "   ‚Ä¢ Weekly K-Line chart with capital flow analysis"
          echo "   ‚Ä¢ 5-year historical coverage (CHT_CAT=WEEK)"
          echo "   ‚Ä¢ Institutional capital flow trends"
          echo "   ‚Ä¢ Weekly price and volume patterns"
        elif [[ "${{ steps.params.outputs.data_type }}" == "18" ]]; then
          echo "üÜï Type 18 Features:"
          echo "   ‚Ä¢ Daily K-Line chart with capital flow analysis"
          echo "   ‚Ä¢ 1-year historical coverage (CHT_CAT=DATE)"
          echo "   ‚Ä¢ Daily capital flow tracking"
          echo "   ‚Ä¢ Short-term price momentum analysis"
        elif [[ "${{ steps.params.outputs.data_type }}" == "11" ]]; then
          echo "üìä Type 11 Features:"
          echo "   ‚Ä¢ Comprehensive weekly OHLC price data"
          echo "   ‚Ä¢ Trading volume and turnover analysis"
          echo "   ‚Ä¢ Institutional flows (Â§ñË≥á/Êäï‰ø°/Ëá™Ááü)"
          echo "   ‚Ä¢ Margin trading and short selling data"
          echo "   ‚Ä¢ Market microstructure analysis"
          echo "   ‚Ä¢ 5-year historical coverage"
        fi
        
        echo "=========================================="
        
        # Record download start time
        DOWNLOAD_START=$(date -u +%s)
        
        # Run GetAll.py with parameters
        set +e  # Disable exit on error
        python GetAll.py ${{ steps.params.outputs.data_type }} ${{ steps.params.outputs.test_flag }} 
        SCRIPT_EXIT_CODE=$?
        set -e  # Re-enable exit on error
        
        # Record download end time
        DOWNLOAD_END=$(date -u +%s)
        DOWNLOAD_DURATION=$((DOWNLOAD_END - DOWNLOAD_START))
        
        echo "download_duration=$DOWNLOAD_DURATION" >> $GITHUB_OUTPUT
        echo "script_exit_code=$SCRIPT_EXIT_CODE" >> $GITHUB_OUTPUT
        
        echo "=========================================="
        echo "Download execution completed"
        echo "Script exit code: $SCRIPT_EXIT_CODE"
        echo "Download duration: ${DOWNLOAD_DURATION}s"
        
        # Enhanced status reporting for Type 12
        if [[ "${{ steps.params.outputs.data_type }}" == "12" ]]; then
          if [ $SCRIPT_EXIT_CODE -eq 0 ]; then
            echo "üéâ NEW! EPS x PER Monthly - 20-Year Analysis completed successfully!"
          else
            echo "‚ö†Ô∏è NEW! EPS x PER Monthly encountered issues - check logs for details"
          fi
        elif [[ "${{ steps.params.outputs.data_type }}" == "11" ]]; then
          if [ $SCRIPT_EXIT_CODE -eq 0 ]; then
            echo "üéâ Weekly Trading Data with Institutional Flows completed successfully!"
          else
            echo "‚ö†Ô∏è Weekly Trading Data encountered issues - check logs for details"
          fi
        fi
        
        # Check if we hit timeout
        if [ $DOWNLOAD_DURATION -ge 18000 ]; then  # 18000s = 5 hours
          echo "‚ö†Ô∏è Download hit timeout limit (5 hours)"
          echo "download_status=TIMEOUT" >> $GITHUB_OUTPUT
        elif [ $SCRIPT_EXIT_CODE -eq 0 ]; then
          echo "‚úÖ Download completed successfully"
          echo "download_status=SUCCESS" >> $GITHUB_OUTPUT
        else
          echo "‚ùå Download failed with exit code: $SCRIPT_EXIT_CODE"
          echo "download_status=FAILED" >> $GITHUB_OUTPUT
        fi

    - name: Calculate File Summary
      id: file_summary
      if: always()  # Always run to capture partial results
      run: |
        echo "Calculating file summary for all 18 data types..."
        echo "Previous step status: ${{ steps.download.outputs.download_status || 'UNKNOWN' }}"
        
        # Initialize variables with default values
        TOTAL_FILES=0
        CURRENT_TYPE_FILES=0
        TOTAL_STOCKS=0
        PROCESSED_STOCKS=0
        SUCCESS_STOCKS=0
        FAILED_STOCKS=0
        
        # Function to count files safely
        count_files() {
          local folder="$1"
          local name="$2"
          
          if [ -d "$folder" ]; then
            local count=$(find "$folder" -name "*.xls*" 2>/dev/null | wc -l || echo "0")
            echo "$name files: $count"
            TOTAL_FILES=$((TOTAL_FILES + count))
            
            # If this is the current data type folder, save count
            case "${{ steps.params.outputs.data_type }}" in
              1) if [ "$folder" = "DividendDetail" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              2) if [ "$folder" = "BasicInfo" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              3) if [ "$folder" = "StockDetail" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              4) if [ "$folder" = "StockBzPerformance" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              5) if [ "$folder" = "ShowSaleMonChart" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              6) if [ "$folder" = "EquityDistribution" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              7) if [ "$folder" = "StockBzPerformance1" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              8) if [ "$folder" = "ShowK_ChartFlow" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              9) if [ "$folder" = "StockHisAnaQuar" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              10) if [ "$folder" = "EquityDistributionClassHis" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              11) if [ "$folder" = "WeeklyTradingData" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              12) if [ "$folder" = "ShowMonthlyK_ChartFlow" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              13) if [ "$folder" = "ShowMarginChart" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              14) if [ "$folder" = "ShowMarginChartWeek" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              15) if [ "$folder" = "ShowMarginChartMonth" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              16) if [ "$folder" = "StockFinDetail" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              17) if [ "$folder" = "ShowWeeklyK_ChartFlow" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              18) if [ "$folder" = "ShowDailyK_ChartFlow" ]; then CURRENT_TYPE_FILES=$count; fi ;;
            esac
          else
            echo "$name files: 0 (folder not created)"
          fi
        }
        
        # Count files for all 18 data types (Enhanced for v3.2.0)
        count_files "DividendDetail" "Dividend"
        count_files "BasicInfo" "Basic info"
        count_files "StockDetail" "Stock detail"
        count_files "StockBzPerformance" "Business performance"
        count_files "ShowSaleMonChart" "Monthly revenue"
        count_files "EquityDistribution" "Equity distribution"
        count_files "StockBzPerformance1" "Quarterly performance"
        count_files "ShowK_ChartFlow" "EPS x PER weekly"
        count_files "StockHisAnaQuar" "Quarterly analysis"
        count_files "EquityDistributionClassHis" "Equity class weekly"
        count_files "WeeklyTradingData" "Weekly trading data"
        count_files "ShowMonthlyK_ChartFlow" "EPS x PER monthly" # üÜï NEW Type 12!
        count_files "ShowMarginChart" "Daily margin balance" # üÜï NEW Type 13!
        count_files "ShowMarginChartWeek" "Weekly margin balance" # üÜï NEW Type 14!
        count_files "ShowMarginChartMonth" "Monthly margin balance" # üÜï NEW Type 15!
        count_files "StockFinDetail" "Quarterly financial ratio analysis" # üÜï NEW Type 16!
        count_files "ShowWeeklyK_ChartFlow" "Weekly K-Line chart flow" # üÜï NEW Type 17!
        count_files "ShowDailyK_ChartFlow" "Daily K-Line chart flow" # üÜï NEW Type 18!

        echo "Total XLS files across all 18 data types: $TOTAL_FILES"
        echo "Current type files: $CURRENT_TYPE_FILES"
        
        # Enhanced Type 12-18 reporting (v3.2.0)
        if [[ "${{ steps.params.outputs.data_type }}" == "12" ]]; then
          echo "üÜï Type 12 (EPS x PER Monthly) files: $CURRENT_TYPE_FILES"
          echo "üìä This includes 20-year long-term valuation analysis!"
        elif [[ "${{ steps.params.outputs.data_type }}" == "13" ]]; then
          echo "üÜï Type 13 (Daily Margin Balance) files: $CURRENT_TYPE_FILES"
        elif [[ "${{ steps.params.outputs.data_type }}" == "16" ]]; then
          echo "üÜï Type 16 (Quarterly Financial Ratio Analysis) files: $CURRENT_TYPE_FILES"
        elif [[ "${{ steps.params.outputs.data_type }}" == "17" ]]; then
          echo "üÜï Type 17 (Weekly K-Line Chart Flow) files: $CURRENT_TYPE_FILES"
          echo "üìä This includes 5-year weekly capital flow analysis!"
        elif [[ "${{ steps.params.outputs.data_type }}" == "18" ]]; then
          echo "üÜï Type 18 (Daily K-Line Chart Flow) files: $CURRENT_TYPE_FILES"
          echo "üìä This includes 1-year daily capital flow analysis!"
        elif [[ "${{ steps.params.outputs.data_type }}" == "11" ]]; then
          echo "üìä Type 11 (Weekly Trading Data) files: $CURRENT_TYPE_FILES"
          echo "üìà This includes comprehensive institutional flow analysis!"
        fi
        
        # Parse download results for current data type (Enhanced for Type 18 - v3.2.0)
        CURRENT_FOLDER=""
        case "${{ steps.params.outputs.data_type }}" in
          1) CURRENT_FOLDER="DividendDetail" ;;
          2) CURRENT_FOLDER="BasicInfo" ;;
          3) CURRENT_FOLDER="StockDetail" ;;
          4) CURRENT_FOLDER="StockBzPerformance" ;;
          5) CURRENT_FOLDER="ShowSaleMonChart" ;;
          6) CURRENT_FOLDER="EquityDistribution" ;;
          7) CURRENT_FOLDER="StockBzPerformance1" ;;
          8) CURRENT_FOLDER="ShowK_ChartFlow" ;;
          9) CURRENT_FOLDER="StockHisAnaQuar" ;;
          10) CURRENT_FOLDER="EquityDistributionClassHis" ;;
          11) CURRENT_FOLDER="WeeklyTradingData" ;;
          12) CURRENT_FOLDER="ShowMonthlyK_ChartFlow" ;;
          13) CURRENT_FOLDER="ShowMarginChart" ;;
          14) CURRENT_FOLDER="ShowMarginChartWeek" ;;
          15) CURRENT_FOLDER="ShowMarginChartMonth" ;;
          16) CURRENT_FOLDER="StockFinDetail" ;;
          17) CURRENT_FOLDER="ShowWeeklyK_ChartFlow" ;;
          18) CURRENT_FOLDER="ShowDailyK_ChartFlow" ;;
        esac
        
        # Extract stock processing statistics safely
        if [ -f "$CURRENT_FOLDER/download_results.csv" ] && [ -n "$CURRENT_FOLDER" ]; then
          echo ""
          echo "Stock Processing Summary:"
          
          # Parse CSV to get statistics with safe defaults and proper integer handling
          TOTAL_STOCKS=$(tail -n +2 "$CURRENT_FOLDER/download_results.csv" 2>/dev/null | wc -l 2>/dev/null | tr -d '\n' | tr -d ' ')
          TOTAL_STOCKS=${TOTAL_STOCKS:-0}
          PROCESSED_STOCKS=$TOTAL_STOCKS
          
          # Count success and failures with explicit integer conversion
          if [ -f "$CURRENT_FOLDER/download_results.csv" ]; then
            SUCCESS_COUNT=$(tail -n +2 "$CURRENT_FOLDER/download_results.csv" 2>/dev/null | grep ",true" 2>/dev/null | wc -l 2>/dev/null | tr -d '\n' | tr -d ' ')
            FAILED_COUNT=$(tail -n +2 "$CURRENT_FOLDER/download_results.csv" 2>/dev/null | grep ",false" 2>/dev/null | wc -l 2>/dev/null | tr -d '\n' | tr -d ' ')
          else
            SUCCESS_COUNT="0"
            FAILED_COUNT="0"
          fi
          
          # Ensure variables are clean integers
          SUCCESS_STOCKS=$(echo "${SUCCESS_COUNT:-0}" | sed 's/[^0-9]//g')
          FAILED_STOCKS=$(echo "${FAILED_COUNT:-0}" | sed 's/[^0-9]//g')
          SUCCESS_STOCKS=${SUCCESS_STOCKS:-0}
          FAILED_STOCKS=${FAILED_STOCKS:-0}
          
          echo "Total stocks: $TOTAL_STOCKS"
          echo "Processed: $PROCESSED_STOCKS stocks"
          echo "Successful: $SUCCESS_STOCKS"
          echo "Failed: $FAILED_STOCKS"
          
          # Calculate success rate safely with explicit integer check
          if [ "$TOTAL_STOCKS" -gt 0 ] 2>/dev/null && [ "$SUCCESS_STOCKS" -ge 0 ] 2>/dev/null; then
            SUCCESS_RATE=$(expr $SUCCESS_STOCKS \* 100 / $TOTAL_STOCKS 2>/dev/null || echo "0")
            echo "Success rate: ${SUCCESS_RATE}%"
          fi
        elif [ -f "StockID_TWSE_TPEX.csv" ]; then
          # Fallback to stock list if download_results.csv doesn't exist
          TOTAL_STOCKS=$(tail -n +2 StockID_TWSE_TPEX.csv 2>/dev/null | wc -l || echo "0")
          echo ""
          echo "Stock Processing Summary (from stock list):"
          echo "Total stocks: $TOTAL_STOCKS"
          echo "Processing status: In progress or failed early"
        fi
        
        # Export outputs with safe defaults
        echo "total_files=${TOTAL_FILES:-0}" >> $GITHUB_OUTPUT
        echo "current_type_files=${CURRENT_TYPE_FILES:-0}" >> $GITHUB_OUTPUT
        echo "total_stocks=${TOTAL_STOCKS:-0}" >> $GITHUB_OUTPUT
        echo "success_stocks=${SUCCESS_STOCKS:-0}" >> $GITHUB_OUTPUT
        echo "failed_stocks=${FAILED_STOCKS:-0}" >> $GITHUB_OUTPUT
        echo "processed_stocks=${PROCESSED_STOCKS:-0}" >> $GITHUB_OUTPUT
        
        # Show enhanced folder structure (Updated for v3.2.0)
        echo ""
        echo "Complete folder structure (v3.2.0 - 18 Data Types):"
        for folder in DividendDetail BasicInfo StockDetail StockBzPerformance ShowSaleMonChart EquityDistribution StockBzPerformance1 ShowK_ChartFlow StockHisAnaQuar EquityDistributionClassHis WeeklyTradingData ShowMonthlyK_ChartFlow ShowMarginChart ShowMarginChartWeek ShowMarginChartMonth StockFinDetail ShowWeeklyK_ChartFlow ShowDailyK_ChartFlow; do
          if [ -d "$folder" ]; then
            echo "   $folder/ (exists)"
            if [ "$folder" = "ShowMonthlyK_ChartFlow" ]; then
              echo "     üÜï NEW! 20-year monthly EPS x PER analysis"
            elif [ "$folder" = "WeeklyTradingData" ]; then
              echo "     üìä Comprehensive weekly trading data with institutional flows"
            elif [ "$folder" = "ShowMarginChart" ]; then
              echo "     üÜï NEW! Daily margin balance data"
            elif [ "$folder" = "StockFinDetail" ]; then
              echo "     üÜï NEW! Quarterly financial ratio analysis"
            elif [ "$folder" = "ShowWeeklyK_ChartFlow" ]; then
              echo "     üÜï NEW! 5-year weekly K-Line chart flow analysis"
            elif [ "$folder" = "ShowDailyK_ChartFlow" ]; then
              echo "     üÜï NEW! 1-year daily K-Line chart flow analysis"
            fi
          else
            echo "   $folder/ (not created yet)"
            if [ "$folder" = "ShowMonthlyK_ChartFlow" ]; then
              echo "     üÜï NEW! For Type 12 - EPS x PER Monthly"
            elif [ "$folder" = "WeeklyTradingData" ]; then
              echo "     üìä For Type 11 - Weekly Trading Data"
            elif [ "$folder" = "ShowMarginChart" ]; then
              echo "     üÜï NEW! For Type 13 - Daily Margin Balance"
            elif [ "$folder" = "StockFinDetail" ]; then
              echo "     üÜï NEW! For Type 16 - Quarterly Financial Ratio Analysis"
            elif [ "$folder" = "ShowWeeklyK_ChartFlow" ]; then
              echo "     üÜï NEW! For Type 17 - Weekly K-Line Chart Flow"
            elif [ "$folder" = "ShowDailyK_ChartFlow" ]; then
              echo "     üÜï NEW! For Type 18 - Daily K-Line Chart Flow"
            fi
          fi
        done

    - name: Clean up unwanted download files
      run: |
        echo "Cleaning up unwanted files in download folders..."
        DATA_FOLDERS="DividendDetail BasicInfo StockDetail StockBzPerformance ShowSaleMonChart EquityDistribution StockBzPerformance1 ShowK_ChartFlow StockHisAnaQuar EquityDistributionClassHis WeeklyTradingData ShowMonthlyK_ChartFlow ShowMarginChart ShowMarginChartWeek ShowMarginChartMonth StockFinDetail ShowWeeklyK_ChartFlow ShowDailyK_ChartFlow"
        for folder in $DATA_FOLDERS; do
          if [ -d "$folder" ]; then
            echo "  - Cleaning folder: $folder"
            # Remove files named "Folder (X).xls" or "Folder (X).xlsx" (duplicates)
            find "$folder" -type f -name "* (*).xls*" -delete || true
            # Remove files named "Folder.xls" or "Folder.xlsx" (default un-renamed downloads)
            find "$folder" -type f -name "${folder}.xls" -delete || true
            find "$folder" -type f -name "${folder}.xlsx" -delete || true
            # Remove temporary download files
            find "$folder" -type f -name "*.crdownload" -delete || true
            find "$folder" -type f -name "*.tmp" -delete || true
          fi
        done
        echo "Cleanup complete."

    - name: Commit and Push Results
      id: commit
      if: always()  # Always run to save any progress made
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

        # 1. Stash local changes (downloaded files) to allow clean pull
        echo "Stashing local changes..."
        # -u includes untracked files (new downloads)
        git stash -u

        # 2. Pull latest changes
        echo "Pulling from remote..."
        git pull origin main || echo "Pull failed (possibly due to conflicts). Continuing..."

        # 3. Pop stash to apply our new downloads
        echo "Restoring local changes..."
        # If conflicts occur (e.g. CSVs modified on both ends), we try to keep local
        git stash pop || echo "‚ö†Ô∏è Stash pop had merge conflicts. Local downloads preserved in working tree."

        # 4. REGENERATE README - This is the Critical Fix
        # We regenerate it NOW, so it reflects the final state (Remote + Local)
        # This overwrites any '<<<<<<' conflict markers in README.md if they existed
        echo "Regenerating README.md status table..."
        python download_results_counts.py --update-readme

        # Add files with better error handling
        echo "Adding files to git..."
        git add README.md || true
        
        # Add updated stock list
        git add StockID_TWSE_TPEX.csv || true
        
        echo "Adding data type files..."
        
        # Loop through all 18 data types and add their XLS files and CSV results
        DATA_FOLDERS="DividendDetail BasicInfo StockDetail StockBzPerformance ShowSaleMonChart EquityDistribution StockBzPerformance1 ShowK_ChartFlow StockHisAnaQuar EquityDistributionClassHis WeeklyTradingData ShowMonthlyK_ChartFlow ShowMarginChart ShowMarginChartWeek ShowMarginChartMonth StockFinDetail ShowWeeklyK_ChartFlow ShowDailyK_ChartFlow"
        for folder in $DATA_FOLDERS; do
          if [ -d "$folder" ]; then
            find "$folder" -name "*.xls*" -exec git add {} + 2>/dev/null || true
            [ -f "$folder/download_results.csv" ] && git add "$folder"/download_results.csv || true
            echo "Added $folder files to commit."
          fi
        done

        if git diff --staged --quiet; then
          echo "No changes to commit"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "Changes detected, preparing commit..."
          
          # Create enhanced commit message based on download status (v3.2.0)
          case "${{ steps.download.outputs.download_status }}" in
            "SUCCESS")
              if [[ "${{ steps.params.outputs.data_type }}" == "12" ]]; then
                COMMIT_MSG="üÜï‚úÖ Update EPS x PER Monthly [COMPLETED - NEW FEATURE!]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "13" ]]; then
                COMMIT_MSG="üÜï‚úÖ Update Daily Margin Balance [COMPLETED - NEW FEATURE!]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "14" ]]; then
                COMMIT_MSG="üÜï‚úÖ Update Weekly Margin Balance [COMPLETED - NEW FEATURE!]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "15" ]]; then
                COMMIT_MSG="üÜï‚úÖ Update Monthly Margin Balance [COMPLETED - NEW FEATURE!]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "17" ]]; then
                COMMIT_MSG="üÜï‚úÖ Update Weekly K-Line Chart Flow [COMPLETED - NEW FEATURE!]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "18" ]]; then
                COMMIT_MSG="üÜï‚úÖ Update Daily K-Line Chart Flow [COMPLETED - NEW FEATURE!]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "11" ]]; then
                COMMIT_MSG="üìä‚úÖ Update Weekly Trading Data [COMPLETED]"
              else
                COMMIT_MSG="‚úÖ Update ${{ steps.params.outputs.type_name }} Data [COMPLETED]"
              fi
              ;;
            "TIMEOUT")
              if [[ "${{ steps.params.outputs.data_type }}" == "12" ]]; then
                COMMIT_MSG="üÜï‚è∞ Partial Update EPS x PER Monthly [TIMEOUT at 5h - NEW FEATURE]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "13" ]]; then
                COMMIT_MSG="üÜï‚è∞ Partial Update Daily Margin Balance [TIMEOUT at 5h - NEW FEATURE]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "17" ]]; then
                COMMIT_MSG="üÜï‚è∞ Partial Update Weekly K-Line Chart Flow [TIMEOUT at 5h - NEW FEATURE]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "18" ]]; then
                COMMIT_MSG="üÜï‚è∞ Partial Update Daily K-Line Chart Flow [TIMEOUT at 5h - NEW FEATURE]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "11" ]]; then
                COMMIT_MSG="üìä‚è∞ Partial Update Weekly Trading Data [TIMEOUT at 5h]"
              else
                COMMIT_MSG="‚è∞ Partial Update ${{ steps.params.outputs.type_name }} Data [TIMEOUT at 5h]"
              fi
              ;;
            "FAILED")
              if [[ "${{ steps.params.outputs.data_type }}" == "12" ]]; then
                COMMIT_MSG="üÜï‚ùå Partial Update EPS x PER Monthly [FAILED - NEW FEATURE]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "13" ]]; then
                COMMIT_MSG="üÜï‚ùå Partial Update Daily Margin Balance [FAILED - NEW FEATURE]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "17" ]]; then
                COMMIT_MSG="üÜï‚ùå Partial Update Weekly K-Line Chart Flow [FAILED - NEW FEATURE]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "18" ]]; then
                COMMIT_MSG="üÜï‚ùå Partial Update Daily K-Line Chart Flow [FAILED - NEW FEATURE]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "11" ]]; then
                COMMIT_MSG="üìä‚ùå Partial Update Weekly Trading Data [FAILED]"
              else
                COMMIT_MSG="‚ùå Partial Update ${{ steps.params.outputs.type_name }} Data [FAILED]"
              fi
              ;;
            *)
              if [[ "${{ steps.params.outputs.data_type }}" == "12" ]]; then
                COMMIT_MSG="üÜïüìÑ Update EPS x PER Monthly [UNKNOWN STATUS - NEW FEATURE]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "13" ]]; then
                COMMIT_MSG="üÜïüìÑ Update Daily Margin Balance [UNKNOWN STATUS - NEW FEATURE]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "17" ]]; then
                COMMIT_MSG="üÜïüìÑ Update Weekly K-Line Chart Flow [UNKNOWN STATUS - NEW FEATURE]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "18" ]]; then
                COMMIT_MSG="üÜïüìÑ Update Daily K-Line Chart Flow [UNKNOWN STATUS - NEW FEATURE]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "11" ]]; then
                COMMIT_MSG="üìäüìÑ Update Weekly Trading Data [UNKNOWN STATUS]"
              else
                COMMIT_MSG="üìÑ Update ${{ steps.params.outputs.type_name }} Data [UNKNOWN STATUS]"
              fi
              ;;
          esac
          
          # Add file count and duration to commit message
          COMMIT_MSG="$COMMIT_MSG (${{ steps.file_summary.outputs.current_type_files }} files"
          
          # Add duration if available
          if [[ "${{ steps.download.outputs.download_duration }}" != "" ]]; then
            DURATION_HOURS=$((${{ steps.download.outputs.download_duration }} / 3600))
            DURATION_MINUTES=$(((${{ steps.download.outputs.download_duration }} % 3600) / 60))
            if [ $DURATION_HOURS -gt 0 ]; then
              COMMIT_MSG="$COMMIT_MSG, ${DURATION_HOURS}h${DURATION_MINUTES}m"
            else
              COMMIT_MSG="$COMMIT_MSG, ${DURATION_MINUTES}m"
            fi
          fi
          
          COMMIT_MSG="$COMMIT_MSG)"
          
          # Add mode and trigger info
          if [[ "${{ steps.params.outputs.test_flag }}" == "--test" ]]; then
            COMMIT_MSG="$COMMIT_MSG [Test]"
          fi
          
          COMMIT_MSG="$COMMIT_MSG [${{ steps.params.outputs.trigger_type }}-v3.2.0]"
          COMMIT_MSG="$COMMIT_MSG - $(date '+%Y-%m-%d %H:%M UTC')"
          
          # Commit the changes
          echo "Committing changes..."
          if git commit -m "$COMMIT_MSG"; then
            echo "‚úÖ Commit successful"
          else
            echo "‚ùå Commit failed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Push with retry logic (3 attempts)
          echo "Pushing changes to remote..."
          PUSH_SUCCESS=false
          
          for attempt in {1..3}; do
            echo "Push attempt $attempt of 3..."
            
            if git push origin main; then
              echo "‚úÖ Push successful on attempt $attempt"
              PUSH_SUCCESS=true
              break
            else
              echo "‚ùå Push failed on attempt $attempt"
              
              if [ $attempt -lt 3 ]; then
                echo "Preparing for retry..."
                # Fetch and try to rebase
                git fetch origin
                
                if git rebase origin/main; then
                  echo "‚úÖ Rebase successful, retrying push..."
                else
                  echo "‚ùå Rebase failed, trying merge..."
                  git rebase --abort 2>/dev/null || true
                  
                  if git merge origin/main; then
                    echo "‚úÖ Merge successful, retrying push..."
                  else
                    echo "‚ùå Merge failed, will retry push as-is..."
                  fi
                fi
                
                sleep $((attempt * 2))  # Progressive delay: 2s, 4s, 6s
              fi
            fi
          done
          
          if [ "$PUSH_SUCCESS" = true ]; then
            echo "‚úÖ Changes committed and pushed successfully"
            echo "üìù Commit message: $COMMIT_MSG"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT
            echo "push_status=success" >> $GITHUB_OUTPUT
            
            if [[ "${{ steps.params.outputs.data_type }}" == "12" ]]; then
              echo "üéâ NEW FEATURE! EPS x PER Monthly successfully committed!"
            elif [[ "${{ steps.params.outputs.data_type }}" == "13" ]]; then
              echo "üéâ NEW FEATURE! Daily Margin Balance successfully committed!"
            elif [[ "${{ steps.params.outputs.data_type }}" == "17" ]]; then
              echo "üéâ NEW FEATURE! Weekly K-Line Chart Flow successfully committed!"
            elif [[ "${{ steps.params.outputs.data_type }}" == "18" ]]; then
              echo "üéâ NEW FEATURE! Daily K-Line Chart Flow successfully committed!"
            elif [[ "${{ steps.params.outputs.data_type }}" == "11" ]]; then
              echo "üéâ Weekly Trading Data successfully committed!"
            fi
          else
            echo "‚ùå All push attempts failed, but changes were committed locally"
            echo "üìù Commit message: $COMMIT_MSG"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT
            echo "push_status=failed" >> $GITHUB_OUTPUT
          fi
        fi
        
    - name: Generate Execution Summary
      id: summary
      if: always()
      run: |
        # Calculate total duration
        END_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        END_TIMESTAMP=$(date -u +%s)
        TOTAL_DURATION=$((END_TIMESTAMP - ${{ steps.start.outputs.start_timestamp }}))
        
        # Export summary data
        echo "end_time=$END_TIME" >> $GITHUB_OUTPUT
        echo "start_time=${{ steps.start.outputs.start_time }}" >> $GITHUB_OUTPUT
        echo "duration=${TOTAL_DURATION}s" >> $GITHUB_OUTPUT
        echo "total_files=${{ steps.file_summary.outputs.total_files }}" >> $GITHUB_OUTPUT
        echo "total_stocks=${{ steps.file_summary.outputs.total_stocks }}" >> $GITHUB_OUTPUT
        echo "success_stocks=${{ steps.file_summary.outputs.success_stocks }}" >> $GITHUB_OUTPUT
        echo "failed_stocks=${{ steps.file_summary.outputs.failed_stocks }}" >> $GITHUB_OUTPUT
        
        # Generate enhanced summary report (Updated for v3.2.0)
        cat >> $GITHUB_STEP_SUMMARY << EOF
        # GoodInfo Downloader Execution Summary v3.2.0

        ## Execution Details
        | Attribute | Value |
        |-----------|-------|
        | **Data Type** | Type ${{ steps.params.outputs.data_type }} - ${{ steps.params.outputs.type_name }} |
        | **Frequency** | ${{ steps.params.outputs.frequency }} |
        | **Trigger** | ${{ steps.params.outputs.trigger_type }} |
        | **Mode** | ${{ steps.params.outputs.test_mode }} Mode |
        | **Version** | v3.2.0 - Complete 18 Data Types (Added Type 17/18 K-Line Chart Flow) |
        
        ## Timing Information
        | Metric | Value |
        |--------|-------|
        | **Start Time** | ${{ steps.start.outputs.start_time }} |
        | **End Time** | $END_TIME |
        | **Total Duration** | ${TOTAL_DURATION}s ($(printf '%02d:%02d:%02d' $((TOTAL_DURATION/3600)) $(((TOTAL_DURATION%3600)/60)) $((TOTAL_DURATION%60)))) |
        | **Download Duration** | ${{ steps.download.outputs.download_duration }}s |
        
        ## File Summary
        | Metric | Count |
        |--------|-------|
        | **Current Type Files** | ${{ steps.file_summary.outputs.current_type_files }} |
        | **Total Files (All Types)** | ${{ steps.file_summary.outputs.total_files }} |
        | **Git Changes** | ${{ steps.commit.outputs.has_changes == 'true' && 'Yes' || 'No' }} |
        
        ## Stock Processing Summary
        | Metric | Count |
        |--------|-------|
        | **Total Stocks** | ${{ steps.file_summary.outputs.total_stocks }} |
        | **Processed** | ${{ steps.file_summary.outputs.processed_stocks }} stocks |
        | **Successful** | ${{ steps.file_summary.outputs.success_stocks }} |
        | **Failed** | ${{ steps.file_summary.outputs.failed_stocks }} |
        
        ## Enhanced Features (v3.2.0)
        EOF

        # Add Type 12-18 specific information if applicable (v3.2.0)
        if [[ "${{ steps.params.outputs.data_type }}" == "12" ]]; then
          cat >> $GITHUB_STEP_SUMMARY << EOF
        - üÜï **NEW! EPS x PER Monthly - 20-Year Long-Term Analysis**
        - üìà Conservative P/E multiples (9X-19X)
        - üìä 20-year monthly EPS and P/E ratio data
        - üîç Long-term valuation trend analysis
        - üìÖ Monthly granularity for macro correlation
        - üíº Backtesting and portfolio management support
        - üîó Cross-reference with Type 8 weekly data
        EOF
        elif [[ "${{ steps.params.outputs.data_type }}" == "13" ]]; then
          cat >> $GITHUB_STEP_SUMMARY << EOF
        - üÜï **NEW! Daily Margin Balance - Market Sentiment**
        - üìä Daily financing vs short selling data
        - üìà 1-year historical tracking
        - üîç Daily sentiment change analysis
        EOF
        elif [[ "${{ steps.params.outputs.data_type }}" == "14" ]]; then
          cat >> $GITHUB_STEP_SUMMARY << EOF
        - üÜï **NEW! Weekly Margin Balance - Mid-Term Sentiment**
        - üìä Weekly aggregated margin trends
        - üìà 5-year historical tracking
        EOF
        elif [[ "${{ steps.params.outputs.data_type }}" == "15" ]]; then
          cat >> $GITHUB_STEP_SUMMARY << EOF
        - üÜï **NEW! Monthly Margin Balance - Long-Term Sentiment**
        - üìä Monthly aggregated margin cycles
        - üìà 20-year historical tracking
        EOF
        elif [[ "${{ steps.params.outputs.data_type }}" == "16" ]]; then
          cat >> $GITHUB_STEP_SUMMARY << EOF
        - üÜï **NEW! Quarterly Financial Ratio Analysis**
        - üìä Latest 10-quarter ratio table
        - üìà Profitability, efficiency, leverage highlights
        EOF
        elif [[ "${{ steps.params.outputs.data_type }}" == "17" ]]; then
          cat >> $GITHUB_STEP_SUMMARY << EOF
        - üÜï **NEW! Weekly K-Line Chart Flow - Capital Flow Analysis**
        - üìä Weekly K-Line with capital flow data
        - üìà 5-year historical tracking (CHT_CAT=WEEK)
        - üèõÔ∏è Institutional capital flow trends
        - üìÖ Weekly price and volume patterns
        EOF
        elif [[ "${{ steps.params.outputs.data_type }}" == "18" ]]; then
          cat >> $GITHUB_STEP_SUMMARY << EOF
        - üÜï **NEW! Daily K-Line Chart Flow - Short-Term Analysis**
        - üìä Daily K-Line with capital flow data
        - üìà 1-year historical tracking (CHT_CAT=DATE)
        - üí∞ Daily capital flow tracking
        - üîç Short-term price momentum analysis
        EOF
        elif [[ "${{ steps.params.outputs.data_type }}" == "11" ]]; then
          cat >> $GITHUB_STEP_SUMMARY << EOF
        - üìä **Weekly Trading Data with Institutional Flows**
        - üìà Comprehensive OHLC price data
        - üí∞ Trading volume and turnover analysis
        - üèõÔ∏è Institutional flows (Â§ñË≥á/Êäï‰ø°/Ëá™Ááü)
        - üìà Margin trading and short selling data
        - üîç Market microstructure analysis
        - üìÖ 5-year historical coverage
        EOF
        fi
        
        cat >> $GITHUB_STEP_SUMMARY << EOF
        
        ## Performance Status
        - Workflow Status: ${{ job.status }}
        - Download Status: ${{ steps.download.outputs.script_exit_code == '0' && 'Success' || 'Warning' }}
        - Repository: [${{ github.repository }}](https://github.com/${{ github.repository }})
        - Run ID: [\#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
        
        ---
        *Generated by GoodInfo Downloader v3.2.0 (Added Type 17/18 K-Line Chart Flow)*
        EOF

        # Also output to console for logs (Enhanced for v3.2.0)
        echo "=== Enhanced Execution Summary (v3.2.0) ==="
        echo "Data Type: ${{ steps.params.outputs.type_name }} (Type ${{ steps.params.outputs.data_type }})"
        if [[ "${{ steps.params.outputs.data_type }}" == "12" ]]; then
          echo "üÜï NEW FEATURE! EPS x PER Monthly - 20-Year Long-Term Analysis"
        elif [[ "${{ steps.params.outputs.data_type }}" == "13" ]]; then
          echo "üÜï NEW FEATURE! Daily Margin Balance - Market Sentiment"
        elif [[ "${{ steps.params.outputs.data_type }}" == "14" ]]; then
          echo "üÜï NEW FEATURE! Weekly Margin Balance - Mid-Term Sentiment"
        elif [[ "${{ steps.params.outputs.data_type }}" == "15" ]]; then
          echo "üÜï NEW FEATURE! Monthly Margin Balance - Long-Term Sentiment"
        elif [[ "${{ steps.params.outputs.data_type }}" == "16" ]]; then
          echo "üÜï NEW FEATURE! Quarterly Financial Ratio Analysis"
        elif [[ "${{ steps.params.outputs.data_type }}" == "17" ]]; then
          echo "üÜï NEW FEATURE! Weekly K-Line Chart Flow - 5-Year Capital Flow Analysis"
        elif [[ "${{ steps.params.outputs.data_type }}" == "18" ]]; then
          echo "üÜï NEW FEATURE! Daily K-Line Chart Flow - 1-Year Capital Flow Analysis"
        elif [[ "${{ steps.params.outputs.data_type }}" == "11" ]]; then
          echo "üìä Weekly Trading Data with Institutional Flows"
        fi
        echo "Duration: ${TOTAL_DURATION}s"
        echo "Files: ${{ steps.file_summary.outputs.current_type_files }} (current type), ${{ steps.file_summary.outputs.total_files }} (total)"
        echo "Stocks: ${{ steps.file_summary.outputs.success_stocks }}/${{ steps.file_summary.outputs.total_stocks }} successful"
        echo "Frequency: ${{ steps.params.outputs.frequency }}"
        echo "Status: Completed"