name: GoodInfo Downloader v3.0.0

on:
  # Enhanced Complete Multi-Frequency Automation - Weekly + Daily + Monthly with Type 12-15 (v3.0.0)
  schedule:
    # ========================================
    # CRITICAL DAILY UPDATES (After Market Close)
    # ========================================
    # Type 1: Dividend Detail - DAILY at 4:30 PM Taiwan (8:30 AM UTC) - ç•¶æ—¥åƒ¹ updates after market close
    - cron: '30 8 * * *'   # ðŸ”¥ Daily at 8:30 AM UTC (4:30 PM Taiwan) - Dividend Detail with ç•¶æ—¥åƒ¹

    # Type 5: Monthly Revenue - DAILY at 8:00 PM Taiwan
    - cron: '0 12 * * *'   # Daily at 12 PM UTC (8 PM Taiwan) - Monthly Revenue (Type 5)

    # Type 13: Daily Margin Balance - DAILY at 10:00 PM Taiwan
    - cron: '0 14 * * *'   # Daily at 2 PM UTC (10 PM Taiwan) - Daily Margin Balance (Type 13) ðŸ†•

    # ========================================
    # WEEKLY ROTATION (One type per day at 4 PM Taiwan)
    # ========================================
    - cron: '0 8 * * 2'    # Tuesday at 8 AM UTC (4 PM Taiwan) - Business Performance (Type 4)
    - cron: '0 8 * * 3'    # Wednesday at 8 AM UTC (4 PM Taiwan) - Equity Distribution (Type 6)
    - cron: '0 8 * * 4'    # Thursday at 8 AM UTC (4 PM Taiwan) - Quarterly Performance (Type 7)
    - cron: '0 8 * * 5'    # Friday at 8 AM UTC (4 PM Taiwan) - EPS x PER Weekly (Type 8)
    - cron: '0 8 * * 6'    # Saturday at 8 AM UTC (4 PM Taiwan) - Quarterly Analysis (Type 9)
    - cron: '0 8 * * 0'    # Sunday at 8 AM UTC (4 PM Taiwan) - Equity Class Weekly (Type 10)

    # ========================================
    # WEEKLY EVENING SLOTS (10 PM Taiwan)
    # ========================================
    - cron: '0 14 * * 1'   # Monday at 2 PM UTC (10 PM Taiwan) - Weekly Trading Data (Type 11)
    - cron: '0 14 * * 5'   # Friday at 2 PM UTC (10 PM Taiwan) - Weekly Margin Balance (Type 14) ðŸ†•

    # ========================================
    # MONTHLY UPDATES (First week of each month)
    # ========================================
    - cron: '0 14 1-7 * 2' # First Tuesday 2 PM UTC (10 PM Taiwan) - EPS x PER Monthly (Type 12) ðŸ†•
    - cron: '0 14 1-7 * 3' # First Wednesday 2 PM UTC (10 PM Taiwan) - Monthly Margin Balance (Type 15) ðŸ†•
  
  # Allow manual trigger for all 15 data types (v3.0.0)
  workflow_dispatch:
    inputs:
      data_type:
        description: 'Data type to download (Complete 15 Data Types - v3.0.0)'
        required: false
        default: '1'
        type: choice
        options:
        - '1'   # Dividend Policy (Weekly - Monday)
        - '2'   # Basic Info (Manual only)
        - '3'   # Stock Details (Manual only)
        - '4'   # Business Performance (Weekly - Tuesday)
        - '5'   # Monthly Revenue (Daily)
        - '6'   # Equity Distribution (Weekly - Wednesday)
        - '7'   # Quarterly Performance (Weekly - Thursday)
        - '8'   # EPS x PER Weekly (Weekly - Friday)
        - '9'   # Quarterly Analysis (Weekly - Saturday)
        - '10'  # Equity Class Weekly (Weekly - Sunday)
        - '11'  # Weekly Trading Data (Weekly - Monday Evening)
        - '12'  # EPS x PER Monthly (Monthly - First Tuesday) ðŸ†•
        - '13'  # Daily Margin Balance (Daily - Evening) ðŸ†•
        - '14'  # Weekly Margin Balance (Weekly - Friday Evening) ðŸ†•
        - '15'  # Monthly Margin Balance (Monthly - First Wednesday) ðŸ†•
      test_mode:
        description: 'Test mode (only first 3 stocks)'
        required: false
        default: false
        type: boolean

jobs:
  download:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max for complex workflows including Type 12
    outputs:
      data_type: ${{ steps.params.outputs.data_type }}
      data_desc: ${{ steps.params.outputs.data_desc }}
      total_files: ${{ steps.summary.outputs.total_files }}
      duration: ${{ steps.summary.outputs.duration }}
      start_time: ${{ steps.summary.outputs.start_time }}
      end_time: ${{ steps.summary.outputs.end_time }}
      total_stocks: ${{ steps.summary.outputs.total_stocks }}
      success_stocks: ${{ steps.summary.outputs.success_stocks }}
      failed_stocks: ${{ steps.summary.outputs.failed_stocks }}
    steps:
    - name: Record Start Time
      id: start
      run: |
        START_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        START_TIMESTAMP=$(date -u +%s)
        echo "start_time=$START_TIME" >> $GITHUB_OUTPUT
        echo "start_timestamp=$START_TIMESTAMP" >> $GITHUB_OUTPUT
        echo "Workflow started at: $START_TIME"
    
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Setup Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable xvfb
    
    - name: Download Stock List
      run: |
        echo "Downloading latest Taiwan stock observation list..."
        python Getè§€å¯Ÿåå–®.py
        
        echo "Stock list status:"
        if [ -f "StockID_TWSE_TPEX.csv" ]; then
          echo "Stock list downloaded successfully"
          STOCK_COUNT=$(tail -n +2 StockID_TWSE_TPEX.csv | wc -l)
          echo "Total stocks: $STOCK_COUNT"
          echo "First 5 stocks:"
          head -6 StockID_TWSE_TPEX.csv
          echo "stock_count=$STOCK_COUNT" >> $GITHUB_OUTPUT
        else
          echo "Failed to download stock list"
          exit 1
        fi
    
    - name: Determine Execution Parameters
      id: params
      run: |
        # Enhanced parameter determination for complete 15 data types (v3.0.0)
        if [[ "${{ github.event_name }}" == "schedule" ]]; then
          # For scheduled runs, determine type by day of week, hour, and minute
          HOUR=$(date -u +%H)
          MINUTE=$(date -u +%M)
          DAY_OF_WEEK=$(date -u +%u)  # 1=Monday, 2=Tuesday, 3=Wednesday, 4=Thursday, 5=Friday, 6=Saturday, 7=Sunday
          DAY_OF_MONTH=$(date -u +%d)

          if [[ "$HOUR" == "08" ]]; then
            # Check if this is 08:30 (Type 1 daily) or 08:00 (weekly types)
            if [[ "$MINUTE" == "30" ]]; then
              # 8:30 AM UTC - Type 1 Daily (ç•¶æ—¥åƒ¹ after market close)
              DATA_TYPE="1"
              TYPE_NAME="Dividend Detail"
              FREQUENCY="Daily-AfterMarket"
            else
              # 8:00 AM UTC - Weekly types based on day of week
              case $DAY_OF_WEEK in
                2) DATA_TYPE="4"; TYPE_NAME="Business Performance"; FREQUENCY="Weekly-Tue" ;;
                3) DATA_TYPE="6"; TYPE_NAME="Equity Distribution"; FREQUENCY="Weekly-Wed" ;;
                4) DATA_TYPE="7"; TYPE_NAME="Quarterly Performance"; FREQUENCY="Weekly-Thu" ;;
                5) DATA_TYPE="8"; TYPE_NAME="EPS x PER Weekly"; FREQUENCY="Weekly-Fri" ;;
                6) DATA_TYPE="9"; TYPE_NAME="Quarterly Analysis"; FREQUENCY="Weekly-Sat" ;;
                7) DATA_TYPE="10"; TYPE_NAME="Equity Class Weekly"; FREQUENCY="Weekly-Sun" ;;
                *) DATA_TYPE="4"; TYPE_NAME="Business Performance"; FREQUENCY="Weekly-Default" ;;
              esac
            fi
          elif [[ "$HOUR" == "12" ]]; then
            DATA_TYPE="5"
            TYPE_NAME="Monthly Revenue"
            FREQUENCY="Daily"
          elif [[ "$HOUR" == "14" ]]; then
            if [[ "$DAY_OF_WEEK" == "1" ]]; then
              # Monday 2 PM UTC - Type 11 Weekly Trading Data
              DATA_TYPE="11"
              TYPE_NAME="Weekly Trading Data"
              FREQUENCY="Weekly-Mon-Evening"
            elif [[ "$DAY_OF_WEEK" == "2" ]]; then
              # Tuesday 2 PM UTC
              if [[ $DAY_OF_MONTH -le 7 ]]; then
                # First Tuesday - Type 12 EPS x PER Monthly
                DATA_TYPE="12"
                TYPE_NAME="EPS x PER Monthly"
                FREQUENCY="Monthly-First-Tue"
              else
                # Other Tuesdays - Type 13 Daily Margin Balance
                DATA_TYPE="13"
                TYPE_NAME="Daily Margin Balance"
                FREQUENCY="Daily-Evening"
              fi
            elif [[ "$DAY_OF_WEEK" == "3" ]]; then
              # Wednesday 2 PM UTC
              if [[ $DAY_OF_MONTH -le 7 ]]; then
                # First Wednesday - Type 15 Monthly Margin Balance
                DATA_TYPE="15"
                TYPE_NAME="Monthly Margin Balance"
                FREQUENCY="Monthly-First-Wed"
              else
                # Other Wednesdays - Type 13 Daily Margin Balance
                DATA_TYPE="13"
                TYPE_NAME="Daily Margin Balance"
                FREQUENCY="Daily-Evening"
              fi
            elif [[ "$DAY_OF_WEEK" == "5" ]]; then
              # Friday 2 PM UTC - Type 14 Weekly Margin Balance
              DATA_TYPE="14"
              TYPE_NAME="Weekly Margin Balance"
              FREQUENCY="Weekly-Fri-Evening"
            else
              # Other days at 2 PM UTC - Type 13 Daily Margin Balance
              DATA_TYPE="13"
              TYPE_NAME="Daily Margin Balance"
              FREQUENCY="Daily-Evening"
            fi
          else
            DATA_TYPE="1"
            TYPE_NAME="Dividend Policy"
            FREQUENCY="Fallback"
          fi
          TRIGGER_TYPE="Auto"
        else
          # Manual trigger - use input
          DATA_TYPE="${{ github.event.inputs.data_type || '1' }}"
          TRIGGER_TYPE="Manual"
          FREQUENCY="On-Demand"
          
          # Set type names for manual triggers (Enhanced for complete 12 types)
          case $DATA_TYPE in
            1) TYPE_NAME="Dividend Policy" ;;
            2) TYPE_NAME="Basic Info" ;;
            3) TYPE_NAME="Stock Details" ;;
            4) TYPE_NAME="Business Performance" ;;
            5) TYPE_NAME="Monthly Revenue" ;;
            6) TYPE_NAME="Equity Distribution" ;;
            7) TYPE_NAME="Quarterly Performance" ;;
            8) TYPE_NAME="EPS x PER Weekly" ;;
            9) TYPE_NAME="Quarterly Analysis" ;;
            10) TYPE_NAME="Equity Class Weekly" ;;
            11) TYPE_NAME="Weekly Trading Data" ;;
            12) TYPE_NAME="EPS x PER Monthly" ;;
            13) TYPE_NAME="Daily Margin Balance" ;;
            14) TYPE_NAME="Weekly Margin Balance" ;;
            15) TYPE_NAME="Monthly Margin Balance" ;;
          esac
        fi
        
        echo "data_type=$DATA_TYPE" >> $GITHUB_OUTPUT
        echo "data_desc=$TYPE_NAME" >> $GITHUB_OUTPUT
        echo "type_name=$TYPE_NAME" >> $GITHUB_OUTPUT
        echo "frequency=$FREQUENCY" >> $GITHUB_OUTPUT
        echo "trigger_type=$TRIGGER_TYPE" >> $GITHUB_OUTPUT
        
        # Set test mode flag
        if [[ "${{ github.event.inputs.test_mode }}" == "true" ]]; then
          echo "test_flag=--test" >> $GITHUB_OUTPUT
          echo "mode_desc=Test Mode (3 stocks)" >> $GITHUB_OUTPUT
          TEST_MODE="Test"
        else
          echo "test_flag=" >> $GITHUB_OUTPUT
          echo "mode_desc=Full Mode (all stocks)" >> $GITHUB_OUTPUT
          TEST_MODE="Full"
        fi
        
        echo "test_mode=$TEST_MODE" >> $GITHUB_OUTPUT
        
        # Enhanced execution info with Type 12 support
        echo "Executing: Type $DATA_TYPE ($TYPE_NAME) | $FREQUENCY | $TEST_MODE Mode"
        if [[ "$DATA_TYPE" == "12" ]]; then
          echo "ðŸ†• NEW FEATURE! EPS x PER Monthly - 20-Year Long-Term Valuation Analysis"
        elif [[ "$DATA_TYPE" == "11" ]]; then
          echo "Enhanced Weekly Trading Data with Institutional Flows"
        elif [[ "$DATA_TYPE" == "13" ]]; then
          echo "ðŸ†• NEW FEATURE! Daily Margin Balance - Market Sentiment Analysis"
        elif [[ "$DATA_TYPE" == "14" ]]; then
          echo "ðŸ†• NEW FEATURE! Weekly Margin Balance - 5-Year History"
        elif [[ "$DATA_TYPE" == "15" ]]; then
          echo "ðŸ†• NEW FEATURE! Monthly Margin Balance - 20-Year History"
        fi
        
    - name: Execute Data Download - Type ${{ steps.params.outputs.data_type }} (${{ steps.params.outputs.type_name }})
      id: download
      timeout-minutes: 300  # 5 hours for complex workflows including Type 12
      continue-on-error: true  # Don't fail entire workflow if this times out
      run: |
        export DISPLAY=:99
        Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
        sleep 3
        
        echo "Starting enhanced download execution..."
        echo "Data Type: ${{ steps.params.outputs.type_name }} (Type ${{ steps.params.outputs.data_type }})"
        echo "Frequency: ${{ steps.params.outputs.frequency }}"
        echo "Mode: ${{ steps.params.outputs.mode_desc }}"
        echo "Trigger: ${{ steps.params.outputs.trigger_type }}"
        echo "Version: v3.0.0 - Complete 15 Data Types with Long-Term Monthly P/E & Multi-Frequency Margin Analysis"
        echo "Timeout: 300 minutes (5 hours)"
        
        # Enhanced special workflow information including Type 12
        case "${{ steps.params.outputs.data_type }}" in
          5) echo "Special Workflow: Monthly Revenue - Auto-click æŸ¥20å¹´ button" ;;
          6) echo "Equity Distribution - Shareholder structure analysis" ;;
          7) echo "Special Workflow: Quarterly Performance - Special URL + Auto-click æŸ¥60å¹´ button" ;;
          8) echo "Special Workflow: EPS x PER Weekly - Special URL + Auto-click æŸ¥5å¹´ button" ;;
          9) echo "Standard Workflow: Quarterly Analysis - 4-quarter detailed statistical data" ;;
          10) echo "Special Workflow: Equity Class Weekly - Auto-click æŸ¥5å¹´ button" ;;
          11) echo "Enhanced Workflow: Weekly Trading Data - Special URL + Auto-click æŸ¥5å¹´ button" ;;
          12) echo "ðŸ†• NEW! Enhanced Workflow: EPS x PER Monthly - Special URL + Auto-click æŸ¥20å¹´ button" ;;
          13) echo "ðŸ†• NEW! Enhanced Workflow: Daily Margin Balance - Special URL + Auto-click æŸ¥1å¹´ button" ;;
          14) echo "ðŸ†• NEW! Enhanced Workflow: Weekly Margin Balance - Special URL + Auto-click æŸ¥5å¹´ button" ;;
          15) echo "ðŸ†• NEW! Enhanced Workflow: Monthly Margin Balance - Special URL + Auto-click æŸ¥20å¹´ button" ;;
        esac
        
        # Show Type 12-15 specific features
        if [[ "${{ steps.params.outputs.data_type }}" == "12" ]]; then
          echo "ðŸ†• Type 12 Features:"
          echo "   â€¢ 20-year monthly EPS and P/E ratio data"
          echo "   â€¢ Conservative P/E multiples (9X-19X)"
          echo "   â€¢ Long-term valuation trend analysis"
          echo "   â€¢ Monthly granularity for macro correlation"
          echo "   â€¢ Backtesting and portfolio management support"
          echo "   â€¢ Cross-reference with Type 8 weekly data"
        elif [[ "${{ steps.params.outputs.data_type }}" == "13" ]]; then
          echo "ðŸ†• Type 13 Features:"
          echo "   â€¢ Daily margin balance data (1-year history)"
          echo "   â€¢ Financing vs Short Selling analysis"
          echo "   â€¢ Margin usage and maintenance rates"
          echo "   â€¢ Daily sentiment tracking"
        elif [[ "${{ steps.params.outputs.data_type }}" == "14" ]]; then
          echo "ðŸ†• Type 14 Features:"
          echo "   â€¢ Weekly margin balance data (5-year history)"
          echo "   â€¢ Mid-term sentiment trend analysis"
        elif [[ "${{ steps.params.outputs.data_type }}" == "15" ]]; then
          echo "ðŸ†• Type 15 Features:"
          echo "   â€¢ Monthly margin balance data (20-year history)"
          echo "   â€¢ Long-term sentiment cycle analysis"
        elif [[ "${{ steps.params.outputs.data_type }}" == "11" ]]; then
          echo "ðŸ“Š Type 11 Features:"
          echo "   â€¢ Comprehensive weekly OHLC price data"
          echo "   â€¢ Trading volume and turnover analysis"  
          echo "   â€¢ Institutional flows (å¤–è³‡/æŠ•ä¿¡/è‡ªç‡Ÿ)"
          echo "   â€¢ Margin trading and short selling data"
          echo "   â€¢ Market microstructure analysis"
          echo "   â€¢ 5-year historical coverage"
        fi
        
        echo "=========================================="
        
        # Record download start time
        DOWNLOAD_START=$(date -u +%s)
        
        # Run GetAll.py with parameters
        set +e  # Disable exit on error
        python GetAll.py ${{ steps.params.outputs.data_type }} ${{ steps.params.outputs.test_flag }} 
        SCRIPT_EXIT_CODE=$?
        set -e  # Re-enable exit on error
        
        # Record download end time
        DOWNLOAD_END=$(date -u +%s)
        DOWNLOAD_DURATION=$((DOWNLOAD_END - DOWNLOAD_START))
        
        echo "download_duration=$DOWNLOAD_DURATION" >> $GITHUB_OUTPUT
        echo "script_exit_code=$SCRIPT_EXIT_CODE" >> $GITHUB_OUTPUT
        
        echo "=========================================="
        echo "Download execution completed"
        echo "Script exit code: $SCRIPT_EXIT_CODE"
        echo "Download duration: ${DOWNLOAD_DURATION}s"
        
        # Enhanced status reporting for Type 12
        if [[ "${{ steps.params.outputs.data_type }}" == "12" ]]; then
          if [ $SCRIPT_EXIT_CODE -eq 0 ]; then
            echo "ðŸŽ‰ NEW! EPS x PER Monthly - 20-Year Analysis completed successfully!"
          else
            echo "âš ï¸ NEW! EPS x PER Monthly encountered issues - check logs for details"
          fi
        elif [[ "${{ steps.params.outputs.data_type }}" == "11" ]]; then
          if [ $SCRIPT_EXIT_CODE -eq 0 ]; then
            echo "ðŸŽ‰ Weekly Trading Data with Institutional Flows completed successfully!"
          else
            echo "âš ï¸ Weekly Trading Data encountered issues - check logs for details"
          fi
        fi
        
        # Check if we hit timeout
        if [ $DOWNLOAD_DURATION -ge 18000 ]; then  # 18000s = 5 hours
          echo "âš ï¸ Download hit timeout limit (5 hours)"
          echo "download_status=TIMEOUT" >> $GITHUB_OUTPUT
        elif [ $SCRIPT_EXIT_CODE -eq 0 ]; then
          echo "âœ… Download completed successfully"
          echo "download_status=SUCCESS" >> $GITHUB_OUTPUT
        else
          echo "âŒ Download failed with exit code: $SCRIPT_EXIT_CODE"
          echo "download_status=FAILED" >> $GITHUB_OUTPUT
        fi

    - name: Calculate File Summary
      id: file_summary
      if: always()  # Always run to capture partial results
      run: |
        echo "Calculating file summary for all 12 data types..."
        echo "Previous step status: ${{ steps.download.outputs.download_status || 'UNKNOWN' }}"
        
        # Initialize variables with default values
        TOTAL_FILES=0
        CURRENT_TYPE_FILES=0
        TOTAL_STOCKS=0
        PROCESSED_STOCKS=0
        SUCCESS_STOCKS=0
        FAILED_STOCKS=0
        
        # Function to count files safely
        count_files() {
          local folder="$1"
          local name="$2"
          
          if [ -d "$folder" ]; then
            local count=$(find "$folder" -name "*.xls*" 2>/dev/null | wc -l || echo "0")
            echo "$name files: $count"
            TOTAL_FILES=$((TOTAL_FILES + count))
            
            # If this is the current data type folder, save count
            case "${{ steps.params.outputs.data_type }}" in
              1) if [ "$folder" = "DividendDetail" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              2) if [ "$folder" = "BasicInfo" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              3) if [ "$folder" = "StockDetail" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              4) if [ "$folder" = "StockBzPerformance" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              5) if [ "$folder" = "ShowSaleMonChart" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              6) if [ "$folder" = "EquityDistribution" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              7) if [ "$folder" = "StockBzPerformance1" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              8) if [ "$folder" = "ShowK_ChartFlow" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              9) if [ "$folder" = "StockHisAnaQuar" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              10) if [ "$folder" = "EquityDistributionClassHis" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              11) if [ "$folder" = "WeeklyTradingData" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              12) if [ "$folder" = "ShowMonthlyK_ChartFlow" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              13) if [ "$folder" = "ShowMarginChart" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              14) if [ "$folder" = "ShowMarginChartWeek" ]; then CURRENT_TYPE_FILES=$count; fi ;;
              15) if [ "$folder" = "ShowMarginChartMonth" ]; then CURRENT_TYPE_FILES=$count; fi ;;
            esac
          else
            echo "$name files: 0 (folder not created)"
          fi
        }
        
        # Count files for all 15 data types (Enhanced for v3.0.0)
        count_files "DividendDetail" "Dividend"
        count_files "BasicInfo" "Basic info"
        count_files "StockDetail" "Stock detail"
        count_files "StockBzPerformance" "Business performance"
        count_files "ShowSaleMonChart" "Monthly revenue"
        count_files "EquityDistribution" "Equity distribution"
        count_files "StockBzPerformance1" "Quarterly performance"
        count_files "ShowK_ChartFlow" "EPS x PER weekly"
        count_files "StockHisAnaQuar" "Quarterly analysis"
        count_files "EquityDistributionClassHis" "Equity class weekly"
        count_files "WeeklyTradingData" "Weekly trading data"
        count_files "ShowMonthlyK_ChartFlow" "EPS x PER monthly" # ðŸ†• NEW Type 12!
        count_files "ShowMarginChart" "Daily margin balance" # ðŸ†• NEW Type 13!
        count_files "ShowMarginChartWeek" "Weekly margin balance" # ðŸ†• NEW Type 14!
        count_files "ShowMarginChartMonth" "Monthly margin balance" # ðŸ†• NEW Type 15!
        
        echo "Total XLS files across all 15 data types: $TOTAL_FILES"
        echo "Current type files: $CURRENT_TYPE_FILES"
        
        # Enhanced Type 12-15 reporting
        if [[ "${{ steps.params.outputs.data_type }}" == "12" ]]; then
          echo "ðŸ†• Type 12 (EPS x PER Monthly) files: $CURRENT_TYPE_FILES"
          echo "ðŸ“Š This includes 20-year long-term valuation analysis!"
        elif [[ "${{ steps.params.outputs.data_type }}" == "13" ]]; then
          echo "ðŸ†• Type 13 (Daily Margin Balance) files: $CURRENT_TYPE_FILES"
        elif [[ "${{ steps.params.outputs.data_type }}" == "11" ]]; then
          echo "ðŸ“Š Type 11 (Weekly Trading Data) files: $CURRENT_TYPE_FILES"
          echo "ðŸ“ˆ This includes comprehensive institutional flow analysis!"
        fi
        
        # Parse download results for current data type (Enhanced for Type 12)
        CURRENT_FOLDER=""
        case "${{ steps.params.outputs.data_type }}" in
          1) CURRENT_FOLDER="DividendDetail" ;;
          2) CURRENT_FOLDER="BasicInfo" ;;
          3) CURRENT_FOLDER="StockDetail" ;;
          4) CURRENT_FOLDER="StockBzPerformance" ;;
          5) CURRENT_FOLDER="ShowSaleMonChart" ;;
          6) CURRENT_FOLDER="EquityDistribution" ;;
          7) CURRENT_FOLDER="StockBzPerformance1" ;;
          8) CURRENT_FOLDER="ShowK_ChartFlow" ;;
          9) CURRENT_FOLDER="StockHisAnaQuar" ;;
          10) CURRENT_FOLDER="EquityDistributionClassHis" ;;
          11) CURRENT_FOLDER="WeeklyTradingData" ;;
          12) CURRENT_FOLDER="ShowMonthlyK_ChartFlow" ;;
          13) CURRENT_FOLDER="ShowMarginChart" ;;
          14) CURRENT_FOLDER="ShowMarginChartWeek" ;;
          15) CURRENT_FOLDER="ShowMarginChartMonth" ;;
        esac
        
        # Extract stock processing statistics safely
        if [ -f "$CURRENT_FOLDER/download_results.csv" ] && [ -n "$CURRENT_FOLDER" ]; then
          echo ""
          echo "Stock Processing Summary:"
          
          # Parse CSV to get statistics with safe defaults and proper integer handling
          TOTAL_STOCKS=$(tail -n +2 "$CURRENT_FOLDER/download_results.csv" 2>/dev/null | wc -l 2>/dev/null | tr -d '\n' | tr -d ' ')
          TOTAL_STOCKS=${TOTAL_STOCKS:-0}
          PROCESSED_STOCKS=$TOTAL_STOCKS
          
          # Count success and failures with explicit integer conversion
          if [ -f "$CURRENT_FOLDER/download_results.csv" ]; then
            SUCCESS_COUNT=$(tail -n +2 "$CURRENT_FOLDER/download_results.csv" 2>/dev/null | grep ",true" 2>/dev/null | wc -l 2>/dev/null | tr -d '\n' | tr -d ' ')
            FAILED_COUNT=$(tail -n +2 "$CURRENT_FOLDER/download_results.csv" 2>/dev/null | grep ",false" 2>/dev/null | wc -l 2>/dev/null | tr -d '\n' | tr -d ' ')
          else
            SUCCESS_COUNT="0"
            FAILED_COUNT="0"
          fi
          
          # Ensure variables are clean integers
          SUCCESS_STOCKS=$(echo "${SUCCESS_COUNT:-0}" | sed 's/[^0-9]//g')
          FAILED_STOCKS=$(echo "${FAILED_COUNT:-0}" | sed 's/[^0-9]//g')
          SUCCESS_STOCKS=${SUCCESS_STOCKS:-0}
          FAILED_STOCKS=${FAILED_STOCKS:-0}
          
          echo "Total stocks: $TOTAL_STOCKS"
          echo "Processed: $PROCESSED_STOCKS stocks"
          echo "Successful: $SUCCESS_STOCKS"
          echo "Failed: $FAILED_STOCKS"
          
          # Calculate success rate safely with explicit integer check
          if [ "$TOTAL_STOCKS" -gt 0 ] 2>/dev/null && [ "$SUCCESS_STOCKS" -ge 0 ] 2>/dev/null; then
            SUCCESS_RATE=$(expr $SUCCESS_STOCKS \* 100 / $TOTAL_STOCKS 2>/dev/null || echo "0")
            echo "Success rate: ${SUCCESS_RATE}%"
          fi
        elif [ -f "StockID_TWSE_TPEX.csv" ]; then
          # Fallback to stock list if download_results.csv doesn't exist
          TOTAL_STOCKS=$(tail -n +2 StockID_TWSE_TPEX.csv 2>/dev/null | wc -l || echo "0")
          echo ""
          echo "Stock Processing Summary (from stock list):"
          echo "Total stocks: $TOTAL_STOCKS"
          echo "Processing status: In progress or failed early"
        fi
        
        # Export outputs with safe defaults
        echo "total_files=${TOTAL_FILES:-0}" >> $GITHUB_OUTPUT
        echo "current_type_files=${CURRENT_TYPE_FILES:-0}" >> $GITHUB_OUTPUT
        echo "total_stocks=${TOTAL_STOCKS:-0}" >> $GITHUB_OUTPUT
        echo "success_stocks=${SUCCESS_STOCKS:-0}" >> $GITHUB_OUTPUT
        echo "failed_stocks=${FAILED_STOCKS:-0}" >> $GITHUB_OUTPUT
        echo "processed_stocks=${PROCESSED_STOCKS:-0}" >> $GITHUB_OUTPUT
        
        # Show enhanced folder structure (Updated for v2.0.0)
        echo ""
        echo "Complete folder structure (v3.0.0 - 15 Data Types):"
        for folder in DividendDetail BasicInfo StockDetail StockBzPerformance ShowSaleMonChart EquityDistribution StockBzPerformance1 ShowK_ChartFlow StockHisAnaQuar EquityDistributionClassHis WeeklyTradingData ShowMonthlyK_ChartFlow ShowMarginChart ShowMarginChartWeek ShowMarginChartMonth; do
          if [ -d "$folder" ]; then
            echo "   $folder/ (exists)"
            if [ "$folder" = "ShowMonthlyK_ChartFlow" ]; then
              echo "     ðŸ†• NEW! 20-year monthly EPS x PER analysis"
            elif [ "$folder" = "WeeklyTradingData" ]; then
              echo "     ðŸ“Š Comprehensive weekly trading data with institutional flows"
            elif [ "$folder" = "ShowMarginChart" ]; then
              echo "     ðŸ†• NEW! Daily margin balance data"
            fi
          else
            echo "   $folder/ (not created yet)"
            if [ "$folder" = "ShowMonthlyK_ChartFlow" ]; then
              echo "     ðŸ†• NEW! For Type 12 - EPS x PER Monthly"
            elif [ "$folder" = "WeeklyTradingData" ]; then
              echo "     ðŸ“Š For Type 11 - Weekly Trading Data"
            elif [ "$folder" = "ShowMarginChart" ]; then
              echo "     ðŸ†• NEW! For Type 13 - Daily Margin Balance"
            fi
          fi
        done

    - name: Clean up unwanted download files
      run: |
        echo "Cleaning up unwanted files in download folders..."
        DATA_FOLDERS="DividendDetail BasicInfo StockDetail StockBzPerformance ShowSaleMonChart EquityDistribution StockBzPerformance1 ShowK_ChartFlow StockHisAnaQuar EquityDistributionClassHis WeeklyTradingData ShowMonthlyK_ChartFlow ShowMarginChart ShowMarginChartWeek ShowMarginChartMonth"
        for folder in $DATA_FOLDERS; do
          if [ -d "$folder" ]; then
            echo "  - Cleaning folder: $folder"
            # Remove files named "Folder (X).xls" or "Folder (X).xlsx" (duplicates)
            find "$folder" -type f -name "* (*).xls*" -delete || true
            # Remove files named "Folder.xls" or "Folder.xlsx" (default un-renamed downloads)
            find "$folder" -type f -name "${folder}.xls" -delete || true
            find "$folder" -type f -name "${folder}.xlsx" -delete || true
            # Remove temporary download files
            find "$folder" -type f -name "*.crdownload" -delete || true
            find "$folder" -type f -name "*.tmp" -delete || true
          fi
        done
        echo "Cleanup complete."

    - name: Generate download_results_counts and update to README.md
      if: always()  # Always run to update README with current status
      run: |
        python download_results_counts.py --update-readme

    - name: Commit and Push Results
      id: commit
      if: always()  # Always run to save any progress made
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

        # ðŸ“„ PULL LATEST CHANGES FIRST to avoid conflicts
        echo "Fetching latest changes from remote..."
        git fetch origin
        
        echo "Pulling latest changes..."
        if git pull origin main; then
          echo "âœ… Successfully pulled latest changes"
        else
          echo "âš ï¸ Pull had conflicts or failed, will attempt to resolve..."
          # Try to reset and pull again
          git reset --hard HEAD
          git pull origin main || echo "Pull still failed, continuing with commit attempt..."
        fi

        # Add files with better error handling
        echo "Adding files to git..."
        git add README.md || true
        
        # Add updated stock list
        git add StockID_TWSE_TPEX.csv || true
        
        echo "Adding data type files..."
        
        # Loop through all 15 data types and add their XLS files and CSV results
        DATA_FOLDERS="DividendDetail BasicInfo StockDetail StockBzPerformance ShowSaleMonChart EquityDistribution StockBzPerformance1 ShowK_ChartFlow StockHisAnaQuar EquityDistributionClassHis WeeklyTradingData ShowMonthlyK_ChartFlow ShowMarginChart ShowMarginChartWeek ShowMarginChartMonth"
        for folder in $DATA_FOLDERS; do
          if [ -d "$folder" ]; then
            find "$folder" -name "*.xls*" -exec git add {} + 2>/dev/null || true
            [ -f "$folder/download_results.csv" ] && git add "$folder"/download_results.csv || true
            echo "Added $folder files to commit."
          fi
        done

        if git diff --staged --quiet; then
          echo "No changes to commit"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "Changes detected, preparing commit..."
          
          # Create enhanced commit message based on download status
          case "${{ steps.download.outputs.download_status }}" in
            "SUCCESS")
              if [[ "${{ steps.params.outputs.data_type }}" == "12" ]]; then
                COMMIT_MSG="ðŸ†•âœ… Update EPS x PER Monthly [COMPLETED - NEW FEATURE!]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "13" ]]; then
                COMMIT_MSG="ðŸ†•âœ… Update Daily Margin Balance [COMPLETED - NEW FEATURE!]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "14" ]]; then
                COMMIT_MSG="ðŸ†•âœ… Update Weekly Margin Balance [COMPLETED - NEW FEATURE!]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "15" ]]; then
                COMMIT_MSG="ðŸ†•âœ… Update Monthly Margin Balance [COMPLETED - NEW FEATURE!]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "11" ]]; then
                COMMIT_MSG="ðŸ“Šâœ… Update Weekly Trading Data [COMPLETED]"
              else
                COMMIT_MSG="âœ… Update ${{ steps.params.outputs.type_name }} Data [COMPLETED]"
              fi
              ;;
            "TIMEOUT")
              if [[ "${{ steps.params.outputs.data_type }}" == "12" ]]; then
                COMMIT_MSG="ðŸ†•â° Partial Update EPS x PER Monthly [TIMEOUT at 5h - NEW FEATURE]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "13" ]]; then
                COMMIT_MSG="ðŸ†•â° Partial Update Daily Margin Balance [TIMEOUT at 5h - NEW FEATURE]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "11" ]]; then
                COMMIT_MSG="ðŸ“Šâ° Partial Update Weekly Trading Data [TIMEOUT at 5h]"
              else
                COMMIT_MSG="â° Partial Update ${{ steps.params.outputs.type_name }} Data [TIMEOUT at 5h]"
              fi
              ;;
            "FAILED")
              if [[ "${{ steps.params.outputs.data_type }}" == "12" ]]; then
                COMMIT_MSG="ðŸ†•âŒ Partial Update EPS x PER Monthly [FAILED - NEW FEATURE]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "13" ]]; then
                COMMIT_MSG="ðŸ†•âŒ Partial Update Daily Margin Balance [FAILED - NEW FEATURE]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "11" ]]; then
                COMMIT_MSG="ðŸ“ŠâŒ Partial Update Weekly Trading Data [FAILED]"
              else
                COMMIT_MSG="âŒ Partial Update ${{ steps.params.outputs.type_name }} Data [FAILED]"
              fi
              ;;
            *)
              if [[ "${{ steps.params.outputs.data_type }}" == "12" ]]; then
                COMMIT_MSG="ðŸ†•ðŸ“„ Update EPS x PER Monthly [UNKNOWN STATUS - NEW FEATURE]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "13" ]]; then
                COMMIT_MSG="ðŸ†•ðŸ“„ Update Daily Margin Balance [UNKNOWN STATUS - NEW FEATURE]"
              elif [[ "${{ steps.params.outputs.data_type }}" == "11" ]]; then
                COMMIT_MSG="ðŸ“ŠðŸ“„ Update Weekly Trading Data [UNKNOWN STATUS]"
              else
                COMMIT_MSG="ðŸ“„ Update ${{ steps.params.outputs.type_name }} Data [UNKNOWN STATUS]"
              fi
              ;;
          esac
          
          # Add file count and duration to commit message
          COMMIT_MSG="$COMMIT_MSG (${{ steps.file_summary.outputs.current_type_files }} files"
          
          # Add duration if available
          if [[ "${{ steps.download.outputs.download_duration }}" != "" ]]; then
            DURATION_HOURS=$((${{ steps.download.outputs.download_duration }} / 3600))
            DURATION_MINUTES=$(((${{ steps.download.outputs.download_duration }} % 3600) / 60))
            if [ $DURATION_HOURS -gt 0 ]; then
              COMMIT_MSG="$COMMIT_MSG, ${DURATION_HOURS}h${DURATION_MINUTES}m"
            else
              COMMIT_MSG="$COMMIT_MSG, ${DURATION_MINUTES}m"
            fi
          fi
          
          COMMIT_MSG="$COMMIT_MSG)"
          
          # Add mode and trigger info
          if [[ "${{ steps.params.outputs.test_flag }}" == "--test" ]]; then
            COMMIT_MSG="$COMMIT_MSG [Test]"
          fi
          
          COMMIT_MSG="$COMMIT_MSG [${{ steps.params.outputs.trigger_type }}-v3.0.0]"
          COMMIT_MSG="$COMMIT_MSG - $(date '+%Y-%m-%d %H:%M UTC')"
          
          # Commit the changes
          echo "Committing changes..."
          if git commit -m "$COMMIT_MSG"; then
            echo "âœ… Commit successful"
          else
            echo "âŒ Commit failed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Push with retry logic (3 attempts)
          echo "Pushing changes to remote..."
          PUSH_SUCCESS=false
          
          for attempt in {1..3}; do
            echo "Push attempt $attempt of 3..."
            
            if git push origin main; then
              echo "âœ… Push successful on attempt $attempt"
              PUSH_SUCCESS=true
              break
            else
              echo "âŒ Push failed on attempt $attempt"
              
              if [ $attempt -lt 3 ]; then
                echo "Preparing for retry..."
                # Fetch and try to rebase
                git fetch origin
                
                if git rebase origin/main; then
                  echo "âœ… Rebase successful, retrying push..."
                else
                  echo "âŒ Rebase failed, trying merge..."
                  git rebase --abort 2>/dev/null || true
                  
                  if git merge origin/main; then
                    echo "âœ… Merge successful, retrying push..."
                  else
                    echo "âŒ Merge failed, will retry push as-is..."
                  fi
                fi
                
                sleep $((attempt * 2))  # Progressive delay: 2s, 4s, 6s
              fi
            fi
          done
          
          if [ "$PUSH_SUCCESS" = true ]; then
            echo "âœ… Changes committed and pushed successfully"
            echo "ðŸ“ Commit message: $COMMIT_MSG"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT
            echo "push_status=success" >> $GITHUB_OUTPUT
            
            if [[ "${{ steps.params.outputs.data_type }}" == "12" ]]; then
              echo "ðŸŽ‰ NEW FEATURE! EPS x PER Monthly successfully committed!"
            elif [[ "${{ steps.params.outputs.data_type }}" == "13" ]]; then
              echo "ðŸŽ‰ NEW FEATURE! Daily Margin Balance successfully committed!"
            elif [[ "${{ steps.params.outputs.data_type }}" == "11" ]]; then
              echo "ðŸŽ‰ Weekly Trading Data successfully committed!"
            fi
          else
            echo "âŒ All push attempts failed, but changes were committed locally"
            echo "ðŸ“ Commit message: $COMMIT_MSG"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT
            echo "push_status=failed" >> $GITHUB_OUTPUT
          fi
        fi
        
    - name: Generate Execution Summary
      id: summary
      if: always()
      run: |
        # Calculate total duration
        END_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        END_TIMESTAMP=$(date -u +%s)
        TOTAL_DURATION=$((END_TIMESTAMP - ${{ steps.start.outputs.start_timestamp }}))
        
        # Export summary data
        echo "end_time=$END_TIME" >> $GITHUB_OUTPUT
        echo "start_time=${{ steps.start.outputs.start_time }}" >> $GITHUB_OUTPUT
        echo "duration=${TOTAL_DURATION}s" >> $GITHUB_OUTPUT
        echo "total_files=${{ steps.file_summary.outputs.total_files }}" >> $GITHUB_OUTPUT
        echo "total_stocks=${{ steps.file_summary.outputs.total_stocks }}" >> $GITHUB_OUTPUT
        echo "success_stocks=${{ steps.file_summary.outputs.success_stocks }}" >> $GITHUB_OUTPUT
        echo "failed_stocks=${{ steps.file_summary.outputs.failed_stocks }}" >> $GITHUB_OUTPUT
        
        # Generate enhanced summary report (Updated for v3.0.0)
        cat >> $GITHUB_STEP_SUMMARY << EOF
        # GoodInfo Downloader Execution Summary v3.0.0
        
        ## Execution Details
        | Attribute | Value |
        |-----------|-------|
        | **Data Type** | Type ${{ steps.params.outputs.data_type }} - ${{ steps.params.outputs.type_name }} |
        | **Frequency** | ${{ steps.params.outputs.frequency }} |
        | **Trigger** | ${{ steps.params.outputs.trigger_type }} |
        | **Mode** | ${{ steps.params.outputs.test_mode }} Mode |
        | **Version** | v3.0.0 - Complete 15 Data Types with Long-Term Monthly P/E & Multi-Frequency Margin Analysis |
        
        ## Timing Information
        | Metric | Value |
        |--------|-------|
        | **Start Time** | ${{ steps.start.outputs.start_time }} |
        | **End Time** | $END_TIME |
        | **Total Duration** | ${TOTAL_DURATION}s ($(printf '%02d:%02d:%02d' $((TOTAL_DURATION/3600)) $(((TOTAL_DURATION%3600)/60)) $((TOTAL_DURATION%60)))) |
        | **Download Duration** | ${{ steps.download.outputs.download_duration }}s |
        
        ## File Summary
        | Metric | Count |
        |--------|-------|
        | **Current Type Files** | ${{ steps.file_summary.outputs.current_type_files }} |
        | **Total Files (All Types)** | ${{ steps.file_summary.outputs.total_files }} |
        | **Git Changes** | ${{ steps.commit.outputs.has_changes == 'true' && 'Yes' || 'No' }} |
        
        ## Stock Processing Summary
        | Metric | Count |
        |--------|-------|
        | **Total Stocks** | ${{ steps.file_summary.outputs.total_stocks }} |
        | **Processed** | ${{ steps.file_summary.outputs.processed_stocks }} stocks |
        | **Successful** | ${{ steps.file_summary.outputs.success_stocks }} |
        | **Failed** | ${{ steps.file_summary.outputs.failed_stocks }} |
        
        ## Enhanced Features (v3.0.0)
        EOF
        
        # Add Type 12-15 specific information if applicable
        if [[ "${{ steps.params.outputs.data_type }}" == "12" ]]; then
          cat >> $GITHUB_STEP_SUMMARY << EOF
        - ðŸ†• **NEW! EPS x PER Monthly - 20-Year Long-Term Analysis**
        - ðŸ“ˆ Conservative P/E multiples (9X-19X)
        - ðŸ“Š 20-year monthly EPS and P/E ratio data
        - ðŸ” Long-term valuation trend analysis
        - ðŸ“… Monthly granularity for macro correlation
        - ðŸ’¼ Backtesting and portfolio management support
        - ðŸ”— Cross-reference with Type 8 weekly data
        EOF
        elif [[ "${{ steps.params.outputs.data_type }}" == "13" ]]; then
          cat >> $GITHUB_STEP_SUMMARY << EOF
        - ðŸ†• **NEW! Daily Margin Balance - Market Sentiment**
        - ðŸ“Š Daily financing vs short selling data
        - ðŸ“ˆ 1-year historical tracking
        - ðŸ” Daily sentiment change analysis
        EOF
        elif [[ "${{ steps.params.outputs.data_type }}" == "14" ]]; then
          cat >> $GITHUB_STEP_SUMMARY << EOF
        - ðŸ†• **NEW! Weekly Margin Balance - Mid-Term Sentiment**
        - ðŸ“Š Weekly aggregated margin trends
        - ðŸ“ˆ 5-year historical tracking
        EOF
        elif [[ "${{ steps.params.outputs.data_type }}" == "15" ]]; then
          cat >> $GITHUB_STEP_SUMMARY << EOF
        - ðŸ†• **NEW! Monthly Margin Balance - Long-Term Sentiment**
        - ðŸ“Š Monthly aggregated margin cycles
        - ðŸ“ˆ 20-year historical tracking
        EOF
        elif [[ "${{ steps.params.outputs.data_type }}" == "11" ]]; then
          cat >> $GITHUB_STEP_SUMMARY << EOF
        - ðŸ“Š **Weekly Trading Data with Institutional Flows**
        - ðŸ“ˆ Comprehensive OHLC price data
        - ðŸ’° Trading volume and turnover analysis
        - ðŸ›ï¸ Institutional flows (å¤–è³‡/æŠ•ä¿¡/è‡ªç‡Ÿ)
        - ðŸ“ˆ Margin trading and short selling data
        - ðŸ” Market microstructure analysis
        - ðŸ“… 5-year historical coverage
        EOF
        fi
        
        cat >> $GITHUB_STEP_SUMMARY << EOF
        
        ## Performance Status
        - Workflow Status: ${{ job.status }}
        - Download Status: ${{ steps.download.outputs.script_exit_code == '0' && 'Success' || 'Warning' }}
        - Repository: [${{ github.repository }}](https://github.com/${{ github.repository }})
        - Run ID: [\#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
        
        ---
        *Generated by GoodInfo Downloader v3.0.0 with Complete 15 Data Types including Long-Term Monthly P/E & Multi-Frequency Margin Analysis*
        EOF
        
        # Also output to console for logs (Enhanced for v3.0.0)
        echo "=== Enhanced Execution Summary (v3.0.0) ==="
        echo "Data Type: ${{ steps.params.outputs.type_name }} (Type ${{ steps.params.outputs.data_type }})"
        if [[ "${{ steps.params.outputs.data_type }}" == "12" ]]; then
          echo "ðŸ†• NEW FEATURE! EPS x PER Monthly - 20-Year Long-Term Analysis"
        elif [[ "${{ steps.params.outputs.data_type }}" == "13" ]]; then
          echo "ðŸ†• NEW FEATURE! Daily Margin Balance - Market Sentiment"
        elif [[ "${{ steps.params.outputs.data_type }}" == "14" ]]; then
          echo "ðŸ†• NEW FEATURE! Weekly Margin Balance - Mid-Term Sentiment"
        elif [[ "${{ steps.params.outputs.data_type }}" == "15" ]]; then
          echo "ðŸ†• NEW FEATURE! Monthly Margin Balance - Long-Term Sentiment"
        elif [[ "${{ steps.params.outputs.data_type }}" == "11" ]]; then
          echo "ðŸ“Š Weekly Trading Data with Institutional Flows"
        fi
        echo "Duration: ${TOTAL_DURATION}s"
        echo "Files: ${{ steps.file_summary.outputs.current_type_files }} (current type), ${{ steps.file_summary.outputs.total_files }} (total)"
        echo "Stocks: ${{ steps.file_summary.outputs.success_stocks }}/${{ steps.file_summary.outputs.total_stocks }} successful"
        echo "Frequency: ${{ steps.params.outputs.frequency }}"
        echo "Status: Completed"
